<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>티처블머신 이미지 인식 - 마이크로비트/ESP32 연동</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/favicon/favicon-16x16.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.6.1/dist/ml5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/makeabilitylab/p5js/_libraries/serial.js"></script>
    <link rel="stylesheet" href="../common/header.css">
    <link rel="stylesheet" href="../common/template.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</head>

<body class="serial-connection">
    <div class="header">
        <a href="../index.html" class="back-btn" title="메인으로 돌아가기">&lt; 메인화면</a>
        <div class="header-content">
            <!-- 접기/펼치기 버튼 -->
            <button id="headerToggleBtn" class="btn-small header-toggle-btn" title="설정 접기/펼치기"></button>
            <div class="desktop-only">
                <!-- 기존 헤더 타이틀/설명 -->
                <div class="header-title-desc">
                  <h1 id="headerTitle">마이크로비트와 티처블머신 연동하기</h1>
                  <p>웹캠을 통한 실시간 이미지 인식으로 마이크로비트/esp32 제어</p>
                </div>
                <div class="header-settings-bar">
                    <!-- 1. MCU 토글 + 에디터 버튼 (왼쪽) -->
                  <div class="header-settings-col header-settings-left">
                    <div class="settings-title">디바이스 선택</div>
                    <div class="toggle-container">
                      <span class="toggle-label">마이크로비트</span>
                      <div class="toggle-switch" id="deviceToggle">
                        <div class="toggle-slider"></div>
                      </div>
                      <span class="toggle-label">ESP32</span>
                    </div>
                    <button id="editorButton" class="btn" onclick="window.open('https://makecode.microbit.org/#editor', '_blank')">
                      마이크로비트 에디터 열기
                    </button>
                  </div>
                  <!-- 2. 모델 URL 입력 (가운데) -->
                  <div class="header-settings-col header-settings-center">
                    <div class="settings-title">티처블머신 URL</div>
                    <form id="modelUrlForm" onsubmit="event.preventDefault(); document.getElementById('loadModelBtn').click();">
                      <input type="text" id="modelUrlInput" class="form-input"
                             placeholder="https://teachablemachine.withgoogle.com/models/xxxxxx/">
                      <button id="loadModelBtn" class="btn">모델 로드</button>
                    </form>
                  </div>
                  <!-- 3. 시리얼 연결 (오른쪽) -->
                  <div class="header-settings-col header-settings-right">
                    <div class="settings-title">디바이스 연결</div>
                    <div class="toggle-container">
                      <span class="toggle-label">시리얼 통신</span>
                      <div class="toggle-switch" id="connectionToggle">
                        <div class="toggle-slider"></div>
                      </div>
                      <span class="toggle-label">블루투스</span>
                    </div>
                    <button id="serialButton" class="btn">시리얼통신 연결</button>
                  </div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="container">
        <div class="main-section">
            <!-- 모바일 경고 메시지 -->
            <div class="mobile-warning">
                <div class="warning-content">
                    <h3>📱 모바일 환경 안내</h3>
                    <p>시리얼 통신을 통한 MCU 연결은 데스크톱 환경에서만 지원됩니다.<br>
                    컴퓨터로 접속해 주세요.</p>
                </div>
            </div>

            <!-- 티처블머신 모델 설정 -->
            

            <div class="content-section desktop-only">
                <div class="video-section">
                    <div class="video-container">
                      <div class="canvas-wrapper" id="canvasContainer">
                        <!-- p5.js canvas will be inserted here -->
                      </div>
                      <div class="video-title">실시간 카메라</div>
                    </div>

                    <div class="status-panel">
                        <div class="video-title">상태 정보</div>
                        <div class="status-item">
                            <span class="status-label">모델 상태:</span>
                            <span id="modelStatus" class="status-value status-waiting">대기중</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">시리얼 연결:</span>
                            <span id="serialStatus" class="status-value status-disconnected">연결 안됨</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">현재 디바이스:</span>
                            <span id="currentDevice" class="status-value status-ready">마이크로비트</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">인식 결과:</span>
                            <span id="recognitionResult" class="status-value status-waiting">-</span>
                        </div>
                    </div>
                </div>

                <div class="instructions">
                    <h3>📋 사용 방법 <span id="instructionsModeLabel"></span></h3>
                    <div id="instructionsContent">
                        <!-- Instructions will be rendered here by JavaScript -->
                    </div>
                </div>

                <div id="codeExamples" class="code-contents hidden">
                    <h3>💻 사용 예시 <span id="exampleModeLabel"></span></h3>
                    <div id="exampleNotice" class="hidden" style="margin: 8px 0 12px; font-weight: 400;">
                        ❗ simpleBLE 라이브러리가 없으면 Thonny의 패키지 관리에서 kocoafab 라이브러리를 다시 설치해 주세요.
                    </div>
                    <div class="code-examples">
                        <div class="example-tabs">
                            <button class="example-tab active" data-example="basic">기본 예시</button>
                            <button class="example-tab" data-example="advanced">스마트홈Plus 키트 모터 제어 예시</button>
                            <button class="example-tab" data-example="custom">파이파이키트 네오픽셀 제어 예시</button>
                        </div>
                        <div class="example-content">
                            <pre class="line-numbers"><code class="language-python">
                                </code></pre>
                            <button class="copy-btn">📋 복사하기</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let isESP32Mode = false;

        const headerSettingsBar = document.querySelector('.header-settings-bar');
        const headerToggleBtn = document.getElementById('headerToggleBtn');
        if(headerToggleBtn && headerSettingsBar) {
            headerToggleBtn.addEventListener('click', () => {
                const isClosed = headerSettingsBar.classList.toggle('closed');
                headerToggleBtn.classList.toggle('closed');
                
                // 컨테이너의 padding-top 값을 동적으로 변경
                const container = document.querySelector('.serial-connection .container');
                if (container) {
                    container.style.paddingTop = isClosed ? '180px' : '360px';
                }
            });
        }
        
        // DOM 요소들
        const deviceToggle = document.getElementById('deviceToggle');
        const editorButton = document.getElementById('editorButton');
        const currentDeviceSpan = document.getElementById('currentDevice');
        const modelUrlInput = document.getElementById('modelUrlInput');
        const loadModelBtn = document.getElementById('loadModelBtn');
        const serialButton = document.getElementById('serialButton');
        const connectionToggle = document.getElementById('connectionToggle');
        const headerTitle = document.getElementById('headerTitle');
        
        // 상태 업데이트 함수들
        window.updateModelStatus = function(status, className = 'status-waiting') {
            const element = document.getElementById('modelStatus');
            if (element) {
                element.textContent = status;
                element.className = 'status-value ' + className;
            }
        };
        
        window.updateSerialStatus = function(status, className = 'status-disconnected') {
            const element = document.getElementById('serialStatus');
            if (element) {
                element.textContent = status;
                element.className = 'status-value ' + className;
            }
        };
        
        window.updateRecognitionResult = function(result) {
            const element = document.getElementById('recognitionResult');
            if (element) {
                element.textContent = result;
                element.className = 'status-value status-ready';
            }
        };

        // 헤더 제목 업데이트 함수
        function updateHeaderTitle(isESP32) {
            const deviceName = isESP32 ? 'ESP32' : '마이크로비트';
            headerTitle.textContent = `${deviceName}와 티처블머신 연동하기`;
        }

        // 디바이스 토글 이벤트
        // Function to render instructions based on current device
        function renderInstructions(isESP32) {
            let instructions;
            if (isESP32) {
                // ESP32: 시리얼/블루투스 분기
                if (window.isBluetoothMode) {
                    instructions = [
                        '헤더에서 디바이스를 ESP32로 설정하세요',
                        '티처블머신 모델 URL을 입력하고 "모델 로드"를 클릭하세요',
                        'Thonny에서 ESP32용 BLE 코드를 작성/업로드하세요',
                        'Thonny에서 실행->인터프리터 환경설정에서<br>실행 환경(인터프리터 탭의 상단 드롭다운)을 Local Python3로 설정하세요',
                        '상단 "연결" 버튼을 눌러 블루투스 연결을 진행하세요',
                        '웹캠 인식 결과가 BLE로 ESP32에 전송됩니다',
                        '코드 수정 시 연결을 끊고(연결 해제) 업로드 후 다시 연결하세요'
                    ];
                } else {
                    instructions = [
                        '헤더에서 디바이스를 ESP32로 설정하세요',
                        '티처블머신 모델 URL을 입력하고 "모델 로드"를 클릭하세요',
                        'Thonny에서 ESP32용 시리얼 통신 코드를 작성/업로드하세요',
                        'Thonny에서 실행->인터프리터 환경설정에서<br>실행 환경(인터프리터 탭의 상단 드롭다운)을 Local Python3로 설정하세요',
                        '상단 "연결" 버튼을 눌러 시리얼 연결을 진행하세요',
                        '웹캠 인식 결과가 시리얼로 ESP32에 전송됩니다',
                        '코드 수정 시 연결을 끊고(연결 해제) 업로드 후 다시 연결하세요'
                    ];
                }
            } else {
                // 마이크로비트: 시리얼/블루투스 분기
                if (window.isBluetoothMode) {
                    instructions = [
                        '헤더에서 디바이스를 마이크로비트로 설정하세요',
                        '티처블머신 모델 URL을 입력하고 "모델 로드"를 클릭하세요',
                        '마이크로비트에 BLE 통신 프로그램을 업로드하세요',
                        '상단 "연결" 버튼을 눌러 블루투스 연결을 진행하세요',
                        '웹캠 인식 결과가 BLE로 마이크로비트에 전송됩니다'
                    ];
                } else {
                    instructions = [
                        '헤더에서 디바이스를 마이크로비트로 설정하세요',
                        '티처블머신 모델 URL을 입력하고 "모델 로드"를 클릭하세요',
                        '마이크로비트 에디터에서 시리얼 통신 코드를 작성/업로드하세요',
                        '상단 "연결" 버튼을 눌러 시리얼 연결을 진행하세요',
                        '웹캠 인식 결과가 시리얼로 마이크로비트에 전송됩니다'
                    ];
                }
            }

            const instructionsHTML = `
                <ol>
                    ${instructions.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
            
            document.getElementById('instructionsContent').innerHTML = instructionsHTML;

            // 타이틀 모드 라벨 갱신
            const instructionsModeLabel = document.getElementById('instructionsModeLabel');
            if (instructionsModeLabel) {
                instructionsModeLabel.textContent = window.isBluetoothMode ? '(블루투스)' : '(시리얼)';
            }

            // Show/hide code examples based on device mode
            const codeExamples = document.getElementById('codeExamples');
            if (codeExamples) {
                codeExamples.classList.toggle('hidden', !isESP32);
                if (isESP32) {
                    initializeCodeExamples();
                }
            }
        }

        // Initial render
        renderInstructions(isESP32Mode);


        function initializeCodeExamples() {
            // Example code content (mode-separated)
            const examples = {
                serial: {
                    basic: `# 티처블머신 데이터 출력하기

while True:
    data = input()
    print(data)`,
                    advanced: `# 스마트홈 모터 제어 예시

from servo import Servo

motor = Servo(pin=13)

while(True):
    data = input()
    if data == 'Class 1':           # 티처블머신 레이블 이름에 맞게 변경 
        motor.move(90)
    elif data == 'Class 2':         # 티처블머신 레이블 이름에 맞게 변경 
        motor.move(30)`,
                    custom: `# 파이파이키트 네오픽셀 제어 예시

from machine import Pin
from neopixel import NeoPixel

pin = Pin(14, Pin.OUT)
np = NeoPixel(pin, 12) 

while(True):
    data = input()
    if data == 'Class 1':           # 티처블머신 레이블 이름에 맞게 변경 
        for i in range(0, 12):
            np[i] = (255, 255, 0)   # Class 1 레이블일 때 노란색 켜기
        np.write()
    elif data == 'Class 2':         # 티처블머신 레이블 이름에 맞게 변경 
        for i in range(0, 12):
            np[i] = (0, 0, 255)     # Class 2 레이블일 때 파란색 켜기
        np.write()`
                },
                bluetooth: {
                    // 초기에는 시리얼 예시와 동일하게 구성 (추후 사용자 교체 예정)
                    basic: `# 티처블머신 데이터 출력하기
import ubluetooth
from simpleBle import WebBLEPeripheral

ble = ubluetooth.BLE()
ble.active(True)

p = WebBLEPeripheral(ble, "ESP32_BLE")


def on_rx(v):
    print("수신", v)
    p.send(f"받은 메시지: {v}")

print("연결 대기 중...")
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    p.stop()
    `,
                    advanced: `# 스마트홈 모터 제어 예시

from servo import Servo
import ubluetooth
from simpleBle import WebBLEPeripheral

ble = ubluetooth.BLE()
ble.active(True)

p = WebBLEPeripheral(ble, "ESP32_BLE")

motor = Servo(pin=13)

def on_rx(v):
    if v == 'Class 1':           # 티처블머신 레이블 이름에 맞게 변경 
        motor.move(90)
    elif v == 'Class 2':         # 티처블머신 레이블 이름에 맞게 변경 
        motor.move(30)
        
print("연결 대기 중...")
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    p.stop()`,
                    custom: `# 파이파이키트 네오픽셀 제어 예시

from machine import Pin
from neopixel import NeoPixel
import ubluetooth
from simpleBle import WebBLEPeripheral

pin = Pin(14, Pin.OUT)
np = NeoPixel(pin, 12) 

ble = ubluetooth.BLE()
ble.active(True)

p = WebBLEPeripheral(ble, "ESP32_BLE")


def on_rx(v):
    if v == 'Class 1':           # 티처블머신 레이블 이름에 맞게 변경 
        for i in range(0, 12):
            np[i] = (255, 255, 0)   # Class 1 레이블일 때 노란색 켜기
        np.write()
    elif v == 'Class 2':         # 티처블머신 레이블 이름에 맞게 변경 
        for i in range(0, 12):
            np[i] = (0, 0, 255)     # Class 2 레이블일 때 파란색 켜기
        np.write()
        
print("연결 대기 중...")
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    p.stop()`,
                }
            };

            // Function to update code content
            function updateCodeContent(exampleType) {
                const exampleContent = document.querySelector('.example-content');
                const codeElement = exampleContent.querySelector('code');
                if (codeElement) {
                    const mode = window.isBluetoothMode ? 'bluetooth' : 'serial';
                    const modeExamples = examples[mode] || examples.serial;
                    codeElement.textContent = modeExamples[exampleType];
                    // Initialize Prism.js syntax highlighting
                    Prism.highlightElement(codeElement);
                }
            }

            // Function to update example mode label (시리얼/블루투스)
            function updateExampleModeLabel() {
                const labelEl = document.getElementById('exampleModeLabel');
                if (!labelEl) return;
                labelEl.textContent = window.isBluetoothMode ? '(블루투스)' : '(시리얼)';
            }

            // Function to update code content for current active tab when mode changes
            function updateExampleContentForMode() {
                const activeTab = document.querySelector('.example-tab.active');
                const currentType = activeTab ? activeTab.dataset.example : 'basic';
                updateCodeContent(currentType);
            }

            // Function to toggle example notice (ESP32 + Bluetooth only)
            function updateExampleNotice() {
                const noticeEl = document.getElementById('exampleNotice');
                if (!noticeEl) return;
                const shouldShow = (window.currentDeviceMode === 'esp32') && !!window.isBluetoothMode;
                noticeEl.classList.toggle('hidden', !shouldShow);
            }

            // 탭 클릭 이벤트 처리
            const exampleTabs = document.querySelectorAll('.example-tab');
            exampleTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const exampleType = tab.dataset.example;
                    const exampleContent = document.querySelector('.example-content');
                    
                    // Deactivate all tabs
                    exampleTabs.forEach(t => t.classList.remove('active'));
                    // Activate clicked tab
                    tab.classList.add('active');
                    
                    // Update code content
                    updateCodeContent(exampleType);
                });
            });

            // Initialize default content
            updateCodeContent('basic');
            updateExampleModeLabel();
            updateExampleNotice();

            // Copy button functionality
            const copyBtn = document.querySelector('.copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const codeElement = document.querySelector('.example-content code');
                    if (!codeElement) {
                        alert('먼저 코드 예시를 선택해주세요.');
                        return;
                    }
                    
                    const code = codeElement.textContent;
                    navigator.clipboard.writeText(code)
                        .then(() => {
                            copyBtn.textContent = '📋 복사됨!';
                            copyBtn.classList.add('success');
                            setTimeout(() => {
                                copyBtn.textContent = '📋 복사하기';
                                copyBtn.classList.remove('success');
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Copy failed:', err);
                            copyBtn.textContent = '❌ 복사 실패';
                            setTimeout(() => {
                                copyBtn.textContent = '📋 복사하기';
                            }, 2000);
                        });
                });
            }

            // 공개: 외부에서 라벨 갱신 호출 가능
            window.updateExampleModeLabel = updateExampleModeLabel;
            window.updateExampleContentForMode = updateExampleContentForMode;
            window.updateExampleNotice = updateExampleNotice;
        }

        deviceToggle.addEventListener('click', function() {
            isESP32Mode = !isESP32Mode;
            deviceToggle.classList.toggle('active', isESP32Mode);
            
            // Update instructions
            renderInstructions(isESP32Mode);
            
            if (isESP32Mode) {
                editorButton.textContent = 'Thonny IDE 다운로드';
                editorButton.onclick = () => window.open('https://thonny.org/', '_blank');
                if (currentDeviceSpan) currentDeviceSpan.textContent = 'ESP32';
            } else {
                editorButton.textContent = '마이크로비트 에디터 열기';
                editorButton.onclick = () => window.open('https://makecode.microbit.org/#editor', '_blank');
                if (currentDeviceSpan) currentDeviceSpan.textContent = '마이크로비트';
            }
            
            // 헤더 제목 업데이트
            updateHeaderTitle(isESP32Mode);
            
            // 전역 변수로 현재 모드 설정
            window.currentDeviceMode = isESP32Mode ? 'esp32' : 'microbit';

            // BLE 모드 동기화
            try {
                if (typeof bleManager !== 'undefined' && bleManager) {
                    bleManager.setMode(isESP32Mode ? 'esp32' : 'microbit');
                }
            } catch (e) {
                console.warn('BLE mode sync failed:', e);
            }

            // 테마 클래스 업데이트
            try {
                const bodyEl = document.body;
                bodyEl.classList.remove('theme-esp32', 'theme-microbit');
                bodyEl.classList.add(isESP32Mode ? 'theme-esp32' : 'theme-microbit');
            } catch (e) {}
        });

        // 모델 로드 버튼 이벤트
        if (loadModelBtn) {
            loadModelBtn.addEventListener('click', function() {
                const url = modelUrlInput.value.trim();
                if (url && window.setModelUrl) {
                    window.setModelUrl(url);
                } else {
                    alert('올바른 모델 URL을 입력하세요.');
                }
            });
        }

        // 연결 모드 상태
        let isBluetoothMode = false;
        // 외부(스케치)에서 접근 가능하도록 공개
        window.isBluetoothMode = isBluetoothMode;

        // 연결 토글 이벤트
        if (connectionToggle) {
            connectionToggle.addEventListener('click', function() {
                isBluetoothMode = !isBluetoothMode;
                connectionToggle.classList.toggle('active', isBluetoothMode);
                if (serialButton) {
                    serialButton.textContent = isBluetoothMode ? '연결' : '연결';
                }
                // 외부 노출 상태 동기화
                window.isBluetoothMode = isBluetoothMode;

                // BLE 모드로 전환되면 시리얼 포트를 닫아 전송 경로를 일관화
                if (isBluetoothMode && typeof window.closeSerialPort === 'function') {
                    window.closeSerialPort();
                }

                // 예시 라벨 갱신
                if (typeof window.updateExampleModeLabel === 'function') {
                    window.updateExampleModeLabel();
                }
                if (typeof window.updateExampleContentForMode === 'function') {
                    window.updateExampleContentForMode();
                }
                if (typeof window.updateExampleNotice === 'function') {
                    window.updateExampleNotice();
                }

                // 사용 방법(Instructions)도 현재 디바이스/모드에 맞춰 재렌더링
                renderInstructions(isESP32Mode);
            });
        }

        // BLE 매니저 인스턴스 (필요 시 생성)
        let bleManager = null;

        // 디바이스(연결) 버튼 이벤트
        if (serialButton) {
            serialButton.addEventListener('click', async function() {
                if (isBluetoothMode) {
                    try {
                        if (!navigator.bluetooth) {
                            alert('이 브라우저는 Web Bluetooth를 지원하지 않습니다. Chrome/Edge를 사용해주세요.');
                            return;
                        }
                        if (!bleManager) {
                            if (!window.BLE || !window.BLE.BLEManager) {
                                alert('BLE 모듈 로드에 실패했습니다.');
                                return;
                            }
                            bleManager = new window.BLE.BLEManager();
                            // 디바이스 토글 상태에 맞춰 모드 설정
                            bleManager.setMode(isESP32Mode ? 'esp32' : 'microbit');
                            // 상태 변경 시 상단 상태 패널 업데이트
                            bleManager.onStatusChange((text, status) => {
                                const className = status === 'connected' ? 'status-ready' : (status === 'connecting' ? 'status-waiting' : 'status-disconnected');
                                window.updateSerialStatus(text, className);
                                // 버튼 라벨 통일: 연결 시 "연결 해제", 그 외 "연결"
                                if (serialButton) {
                                    if (status === 'connected') {
                                        serialButton.textContent = '연결 해제';
                                    } else if (status === 'connecting') {
                                        serialButton.textContent = '연결 중...';
                                    } else {
                                        serialButton.textContent = '연결';
                                    }
                                }
                            });
                            // 외부(스케치)에서 접근 가능하도록 공개
                            window.bleManager = bleManager;
                        }

                        if (bleManager.isConnected()) {
                            await bleManager.disconnect();
                            if (serialButton) serialButton.textContent = '연결';
                        } else {
                            await bleManager.connect();
                            if (serialButton) serialButton.textContent = '연결 해제';
                        }
                    } catch (e) {
                        console.error(e);
                        alert('블루투스 연결 실패: ' + (e && e.message ? e.message : String(e)));
                    }
                } else {
                    if (window.newConnect) {
                        window.newConnect();
                    }
                }
            });
        }

        // 초기 상태 설정
        window.currentDeviceMode = 'microbit';
        updateHeaderTitle(false);
        // 초기 테마 설정
        try {
            document.body.classList.add('theme-microbit');
        } catch (e) {}
    </script>
    
    <script src="../ble/ble.js"></script>
    <script src="sketch.js"></script>
</body>
</html>