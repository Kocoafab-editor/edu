<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‹°ì²˜ë¸”ë¨¸ì‹  ì´ë¯¸ì§€ ì¸ì‹ - ë§ˆì´í¬ë¡œë¹„íŠ¸/ESP32 ì—°ë™</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/favicon/favicon-16x16.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.6.1/dist/ml5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/makeabilitylab/p5js/_libraries/serial.js"></script>
    <link rel="stylesheet" href="../common/header.css">
    <link rel="stylesheet" href="../common/navigation.css">
    <link rel="stylesheet" href="../common/template.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-clike.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-c.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-cpp.min.js"></script>
    <script src="../common/menu.js"></script>
</head>

<body class="serial-connection">
    <div class="header">
        <a href="../index.html" class="back-btn" title="ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°">&lt; ë©”ì¸í™”ë©´</a>
        <div class="header-content">
            <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤: ì¢Œì¸¡ ë„ì›€ë§, ìš°ì¸¡ ì ‘ê¸°/í–„ë²„ê±° -->
            <div class="header-top-controls">
                <!-- <button id="helpButton" class="btn-small help-btn" title="íŠœí† ë¦¬ì–¼ ì‹œì‘">?</button> -->
                <div class="right-controls">
                    <button id="headerToggleBtn"
                        class="btn-small header-toggle-btn"
                        title="ì„¤ì • ì ‘ê¸°/í¼ì¹˜ê¸°"
                        aria-label="ì„¤ì • ì ‘ê¸°/í¼ì¹˜ê¸°">
                    </button>
                    <button class="hamburger-btn" id="hamburgerBtn" aria-label="ë©”ë‰´ ì—´ê¸°"><span></span><span></span><span></span></button>
                </div>
            </div>
            <div>
                <!-- ê¸°ì¡´ í—¤ë” íƒ€ì´í‹€/ì„¤ëª… -->
                <div class="header-title-desc">
                  <h1 id="headerTitle">ë§ˆì´í¬ë¡œë¹„íŠ¸ì™€ í‹°ì²˜ë¸”ë¨¸ì‹  ì—°ë™í•˜ê¸°</h1>
                  <p>í‹°ì²˜ë¸”ë¨¸ì‹ ìœ¼ë¡œ ì›¹ìº ì„ í†µí•´ ë§ˆì´í¬ë¡œì»¨íŠ¸ë¡¤ëŸ¬ ì œì–´</p>
                  <p class="mobile-hint" style="display:none; color:#4a5568; margin-top:6px;">ìš°ì¸¡ ìƒë‹¨ì˜ í–„ë²„ê±° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„¤ì •í•˜ì„¸ìš”.</p>
                </div>
                <div class="header-settings-bar">
                    <!-- 1. MCU í† ê¸€ + ì—ë””í„° ë²„íŠ¼ (ì™¼ìª½) -->
                  <div class="header-settings-col header-settings-left">
                    <div class="settings-title">ë””ë°”ì´ìŠ¤ ì„ íƒ</div>
                    <div class="device-select-container">
                      <select id="deviceSelect" class="device-select" aria-label="ë””ë°”ì´ìŠ¤ ì„ íƒ">
                        <option value="microbit" selected>ë§ˆì´í¬ë¡œë¹„íŠ¸</option>
                        <option value="orange">ì˜¤ë Œì§€ë³´ë“œ</option>
                        <option value="esp32">ESP32</option>
                      </select>
                    </div>
                    <button id="editorButton" class="btn" type="button">ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—ë””í„° ì—´ê¸°</button>
                  </div>
                  <!-- 2. ëª¨ë¸ URL ì…ë ¥ (ê°€ìš´ë°) -->
                  <div class="header-settings-col header-settings-center">
                    <div class="settings-title">í‹°ì²˜ë¸”ë¨¸ì‹  URL</div>
                    <form id="modelUrlForm" onsubmit="event.preventDefault(); document.getElementById('loadModelBtn').click();">
                      <input type="text" id="modelUrlInput" class="form-input"
                             placeholder="https://teachablemachine.withgoogle.com/models/xxxxxx/">
                      <button id="loadModelBtn" class="btn">ëª¨ë¸ ë¡œë“œ</button>
                    </form>
                  </div>
                  <!-- 3. ì‹œë¦¬ì–¼ ì—°ê²° (ì˜¤ë¥¸ìª½) -->
                  <div class="header-settings-col header-settings-right">
                    <div class="settings-title">ë””ë°”ì´ìŠ¤ ì—°ê²°</div>
                    <div class="toggle-container">
                      <span class="toggle-label">ì‹œë¦¬ì–¼ í†µì‹ </span>
                      <div class="toggle-switch" id="connectionToggle">
                        <div class="toggle-slider"></div>
                      </div>
                      <span class="toggle-label">ë¸”ë£¨íˆ¬ìŠ¤</span>
                    </div>
                    <button id="connectButton" class="btn">ì‹œë¦¬ì–¼í†µì‹  ì—°ê²°</button>
                  </div>
                </div>
            </div>
            <!-- ëª¨ë°”ì¼: í–„ë²„ê±° ë²„íŠ¼ & ì˜¤ë²„ë ˆì´ -->
            <div class="nav-overlay" id="navOverlay">
                <div class="nav-overlay-content">
                    <div id="overlaySettingsMount"></div>
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="container">
        <div class="main-section">


            <!-- í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ ì„¤ì • -->
            

            <div class="content-section">
                <div class="video-section">
                    <div class="video-container" id="video-container">
                      <div class="canvas-wrapper" id="canvasContainer">
                        <!-- p5.js canvas will be inserted here -->
                      </div>
                      <div class="video-title">ì‹¤ì‹œê°„ ì¹´ë©”ë¼</div>
                    </div>

                    <div class="status-panel">
                        <div class="video-title">ìƒíƒœ ì •ë³´</div>
                        <div class="status-item">
                            <span class="status-label">ëª¨ë¸ ìƒíƒœ:</span>
                            <span id="modelStatus" class="status-value status-waiting">ëŒ€ê¸°ì¤‘</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label" id="connectionTypeLabel">ì‹œë¦¬ì–¼ ì—°ê²°:</span>
                            <span id="serialStatus" class="status-value status-disconnected">ì—°ê²° ì•ˆë¨</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">í˜„ì¬ ë””ë°”ì´ìŠ¤:</span>
                            <span id="currentDevice" class="status-value status-ready">ë§ˆì´í¬ë¡œë¹„íŠ¸</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ì¸ì‹ ê²°ê³¼:</span>
                            <span id="recognitionResult" class="status-value status-waiting">-</span>
                        </div>
                    </div>
                </div>

                <div class="instructions">
                    <h3>ğŸ“‹ ì‚¬ìš© ë°©ë²• <span id="instructionsModeLabel"></span></h3>
                    <div id="instructionsContent">
                        <!-- Instructions will be rendered here by JavaScript -->
                    </div>
                </div>

                <div id="codeExamples" class="code-contents hidden">
                    <h3>ğŸ’» ì‚¬ìš© ì˜ˆì‹œ <span id="exampleModeLabel"></span></h3>
                    <div id="exampleNotice" class="hidden" style="margin: 8px 0 12px; font-weight: 400;">
                        â— simpleBLE ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ Thonnyì˜ íŒ¨í‚¤ì§€ ê´€ë¦¬ì—ì„œ kocoafab ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ì‹œ ì„¤ì¹˜í•´ ì£¼ì„¸ìš”.
                    </div>
                    <div class="code-examples">
                        <div class="example-tabs"></div>
                        <div class="example-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../ble/ble.js"></script>
    <script src="app_state.js"></script>
    <script src="serial_adapter.js"></script>
    <script src="sketch.js"></script>
    <script src="connection_manager.js"></script>

    <script>
      const headerSettingsBar = document.querySelector('.header-settings-bar');
      const headerToggleBtn   = document.getElementById('headerToggleBtn');

      const deviceToggle        = document.getElementById('deviceToggle');  // (ë ˆê±°ì‹œ: ìˆì„ ìˆ˜ë„/ì—†ì„ ìˆ˜ë„)
      const editorButton        = document.getElementById('editorButton');
      const currentDeviceSpan   = document.getElementById('currentDevice');
      const modelUrlInput       = document.getElementById('modelUrlInput');
      const loadModelBtn        = document.getElementById('loadModelBtn');
      const deviceSelect        = document.getElementById('deviceSelect'); // 'microbit'|'esp32'|'orange'
      const connectButton       = document.getElementById('connectButton');
      const connectionToggle    = document.getElementById('connectionToggle');
      const headerTitle         = document.getElementById('headerTitle');
      const helpButtonDesktop   = document.getElementById('helpButton');
      const helpButtonMobile    = document.getElementById('helpButton'); // (ì¤‘ë³µ idì¼ ìˆ˜ ìˆì–´ null-safeë¡œ ì‚¬ìš©)

      /* ---------- ìœ í‹¸ ---------- */
      const $ = (sel) => document.querySelector(sel);

      const UI_DEVICE_LABEL = { microbit: 'ë§ˆì´í¬ë¡œë¹„íŠ¸', esp32: 'ESP32', orange: 'ì˜¤ë Œì§€ë³´ë“œ' };

      // UIì˜ 'orange' ê°’ì„ AppStateê°€ ì“°ëŠ” 'uno'ë¡œ ë§¤í•‘
      const toStateDevice = (uiValue) => (uiValue === 'orange' ? 'uno' : uiValue);
      // ë°˜ëŒ€ë¡œ BLE Managerì— ë„˜ê¸¸ ë•ŒëŠ” 'uno' -> 'orange'ë¡œ
      const toBleMode = (stateDevice) => (stateDevice === 'uno' ? 'orange' : stateDevice);
      
      function getCurrentUiDevice() {
        return (deviceSelect?.value) || window.currentDeviceMode || 'microbit'; // 'microbit'|'esp32'|'orange'
      }

      function setConnectButtonText(text) {
        const labelEl = document.getElementById('connectBtnText');
        if (labelEl) labelEl.textContent = text;
        else if (connectButton) connectButton.textContent = text;
      }

      function updateConnectionTypeLabel() {
        const labelEl = document.getElementById('connectionTypeLabel');
        if (!labelEl) return;
        labelEl.textContent = (window.isBluetoothMode ? 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°:' : 'ì‹œë¦¬ì–¼ ì—°ê²°:');
      }

      function applyThemeForDevice(device /* ui ê°’: microbit|esp32|orange */) {
        try {
          const bodyEl = document.body;
          bodyEl.classList.remove('theme-esp32', 'theme-microbit', 'theme-orange');
          if (device === 'esp32') bodyEl.classList.add('theme-esp32');
          else if (device === 'orange') bodyEl.classList.add('theme-orange');
          else bodyEl.classList.add('theme-microbit');
        } catch (e) {}
      }

      function updateHeaderTitleByDevice(uiDevice /* 'microbit'|'esp32'|'orange' */) {
        const name = UI_DEVICE_LABEL[uiDevice] || 'ë§ˆì´í¬ë¡œë¹„íŠ¸';
        if (headerTitle) headerTitle.textContent = `${name}ì™€ í‹°ì²˜ë¸”ë¨¸ì‹  ì—°ë™í•˜ê¸°`;
      }

      function isIPadOSDesktopClass() {
        try { return navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1; }
        catch (e) { return false; }
      }
      function detectMobileDevice() {
        const ua = (navigator.userAgent || navigator.vendor || '');
        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet|Silk|Kindle/i.test(ua);
        return isMobileUA || isIPadOSDesktopClass();
      }

      /* ---------- íŠœí† ë¦¬ì–¼ ìƒíƒœ ---------- */
      const TUTORIAL_STORAGE_KEY = 'tm_tutorial_status_v1';
      function getTutorialStatus() {
        try { return localStorage.getItem(TUTORIAL_STORAGE_KEY) || 'not_started'; }
        catch (e) { return 'not_started'; }
      }
      function setTutorialStatus(status) {
        try { localStorage.setItem(TUTORIAL_STORAGE_KEY, status); } catch (e) {}
      }
      function resetTutorialStatus() { setTutorialStatus('not_started'); }
      function beginTutorialFromStart() {
        resetTutorialStatus();
        if (typeof window.startTutorial === 'function') window.startTutorial();
        else { alert('íŠœí† ë¦¬ì–¼ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤.'); setTutorialStatus('in_progress'); }
      }

      /* ---------- ìƒíƒœ ì—…ë°ì´íŠ¸ (sketch.js í˜¸í™˜ ìœ ì§€) ---------- */
      window.updateModelStatus = function(status, className = 'status-waiting') {
        const element = document.getElementById('modelStatus');
        if (element) { element.textContent = status; element.className = 'status-value ' + className; }
      };
      window.updateSerialStatus = function(status, className = 'status-disconnected') {
        const element = document.getElementById('serialStatus');
        if (element) { element.textContent = status; element.className = 'status-value ' + className; }
        // â¬‡ï¸ ConnectionManager & AppStateì— ìƒíƒœ ë°˜ì˜
        try {
          window.AppState?.setSerialPortOpen(/connected/.test(className));
          window.connectionManager?.notifySerialStatusFromUI(status, className);
        } catch (e) {}
      };
      window.updateRecognitionResult = function(result) {
        const element = document.getElementById('recognitionResult');
        if (element) { element.textContent = result; element.className = 'status-value status-ready'; }
      };

      /* ---------- ì—°ê²°/ëª¨ë“œ ì´ˆê¸°ê°’ ---------- */
      window.isMobileDevice = detectMobileDevice();
      window.isBluetoothMode = window.isMobileDevice ? true : false;

      // ì´ˆê¸° ë””ë°”ì´ìŠ¤(UI ê¸°ì¤€) â†’ AppStateìš©ìœ¼ë¡œ ì •ê·œí™”
      const initialUiDevice = (deviceSelect?.value || 'microbit');    // 'microbit'|'esp32'|'orange'
      const initialStateDev = toStateDevice(initialUiDevice);          // 'microbit'|'esp32'|'uno'
      window.currentDeviceMode = initialUiDevice;

      applyThemeForDevice(initialUiDevice);
      updateHeaderTitleByDevice(initialUiDevice);
      if (currentDeviceSpan) {
        // UIëŠ” ê¸°ì¡´ëŒ€ë¡œ 'ORANGE' í‘œê¸° ìœ ì§€(ì›í•˜ì‹œë©´ 'UNO'ë¡œ ë°”ê¾¸ì…”ë„ ë©ë‹ˆë‹¤)
        currentDeviceSpan.textContent = initialUiDevice === 'esp32' ? 'ESP32' :
                                        initialUiDevice === 'orange' ? 'ORANGE' : 'ë§ˆì´í¬ë¡œë¹„íŠ¸';
      }

      /* ---------- AppState / ConnectionManager ì´ˆê¸°í™” ---------- */
      // AppStateì— ì´ˆê¸° ë””ë°”ì´ìŠ¤/ì „ì†¡ê²½ë¡œ ë°˜ì˜
      window.AppState.setDevice(initialStateDev);
      window.AppState.setTransport(window.isBluetoothMode ? 'ble' : 'serial');

      // ìƒíƒœ ë³€ê²½ ì½œë°±: ë²„íŠ¼ ë¼ë²¨/ìƒíƒœ í…ìŠ¤íŠ¸ ê°±ì‹ 
      function onStatusChange({ transport, statusText, status }) {
        if (status === "connecting") setConnectButtonText('ì—°ê²° ì¤‘â€¦');
        else if (status === "connected") setConnectButtonText('ì—°ê²° í•´ì œ');
        else setConnectButtonText(window.isBluetoothMode ? 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°' : 'ì‹œë¦¬ì–¼ ì—°ê²°');

        const el = document.getElementById('serialStatus');
        if (el) {
          el.textContent = statusText || (status === "connected" ? 'ì—°ê²°ë¨' : status === "connecting" ? 'ì—°ê²° ì¤‘â€¦' : 'ì—°ê²° ì•ˆë¨');
          el.className = 'status-value ' + (status === "connected" ? 'status-ready' : status === "connecting" ? 'status-waiting' : 'status-disconnected');
        }
      }

      // âœ… ConnectionManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (AppState, opts)
      window.connectionManager = new window.ConnectionManager(
        window.AppState,
        {
          onStatusChange,
          minIntervalMs: 1000
        }
      );

      /* ---------- í—¤ë” ì ‘ê¸° ---------- */
      if (headerToggleBtn && headerSettingsBar) {
        headerToggleBtn.addEventListener('click', () => {
          const isClosed = headerSettingsBar.classList.toggle('closed');
          headerToggleBtn.classList.toggle('closed');
          const isMobile = window.matchMedia('(max-width: 900px)').matches;
          if (isMobile) return;
          const container = document.querySelector('.serial-connection .container');
          if (container) container.style.paddingTop = isClosed ? '180px' : '360px';
        });
      }

      // === ì˜ˆì‹œ ë°ì´í„° (ì–¸ì–´/ì´ë¯¸ì§€ í¬í•¨) ===
      const EXAMPLES = {
        microbit: {
          sectionTitle: { serial: 'ë§ˆì´í¬ë¡œë¹„íŠ¸: ì‹œë¦¬ì–¼ ì‚¬ìš© ì˜ˆì‹œ', bluetooth: 'ë§ˆì´í¬ë¡œë¹„íŠ¸: ë¸”ë£¨íˆ¬ìŠ¤ ì‚¬ìš© ì˜ˆì‹œ' },
          serial: {
            basic:    { codeUrl: 'https://makecode.microbit.org/_KKr076gscfXJ', kind: 'image', src: 'img/microbit-serial-basic.png',    alt: 'ë§ˆì´í¬ë¡œë¹„íŠ¸ ì‹œë¦¬ì–¼ ê¸°ë³¸ ì˜ˆì‹œ',    title: 'ê²°ê³¼ ì¶œë ¥ ì˜ˆì‹œ' },
            advanced: { codeUrl: 'https://makecode.microbit.org/_PM98hHf7R17s', kind: 'image', src: 'img/microbit-serial-advanced.png', alt: 'ë§ˆì´í¬ë¡œë¹„íŠ¸ ì‹œë¦¬ì–¼ ê³ ê¸‰ ì˜ˆì‹œ',    title: 'ë¹„íŠ¸íŒŸ í™œë™ ì˜ˆì‹œ' },
          },
          bluetooth: {
            basic:    { codeUrl: 'https://makecode.microbit.org/_PKu08i9mmies', kind: 'image', src: 'img/microbit-ble-basic.png',    alt: 'ë§ˆì´í¬ë¡œë¹„íŠ¸ BLE ê¸°ë³¸ ì˜ˆì‹œ',    title: 'ê¸°ë³¸ ì˜ˆì‹œ' },
            advanced: { codeUrl: 'https://makecode.microbit.org/_Cb7bMJ1g6YxK', kind: 'image', src: 'img/microbit-ble-advanced.png', alt: 'ë§ˆì´í¬ë¡œë¹„íŠ¸ BLE ê³ ê¸‰ ì˜ˆì‹œ',    title: 'ë¹„íŠ¸íŒŸ í™œë™ ì˜ˆì‹œ' },
          },
        },

        esp32: {
          sectionTitle: { serial: 'ESP32: ì‹œë¦¬ì–¼ ì½”ë“œ ì˜ˆì‹œ', bluetooth: 'ESP32: ë¸”ë£¨íˆ¬ìŠ¤(BLE) ì½”ë“œ ì˜ˆì‹œ' },
          serial: {
            basic: { kind: 'code', lang: 'python', code:
`# í‹°ì²˜ë¸”ë¨¸ì‹  ë°ì´í„° ì¶œë ¥í•˜ê¸°

while True:
    data = input()
    print(data)`, title: 'ê¸°ë³¸ ì˜ˆì‹œ' },
      advanced: { kind: 'code', lang: 'python', code:
`# ìŠ¤ë§ˆíŠ¸í™ˆ ëª¨í„° ì œì–´ ì˜ˆì‹œ

from servo import Servo

motor = Servo(pin=13)

while(True):
    data = input()
    if data == 'Class 1':
        motor.move(90)
    elif data == 'Class 2':
        motor.move(30)`, title: 'ìŠ¤ë§ˆíŠ¸í™ˆPlus í‚¤íŠ¸ ëª¨í„° ì œì–´ ì˜ˆì‹œ' },
      custom: { kind: 'code', lang: 'python', code:
`# íŒŒì´íŒŒì´í‚¤íŠ¸ ë„¤ì˜¤í”½ì…€ ì œì–´ ì˜ˆì‹œ

from machine import Pin
from neopixel import NeoPixel

pin = Pin(14, Pin.OUT)
np = NeoPixel(pin, 12)

while(True):
    data = input()
    if data == 'Class 1':
        for i in range(0, 12):
            np[i] = (255, 255, 0)
        np.write()
    elif data == 'Class 2':
        for i in range(0, 12):
            np[i] = (0, 0, 255)
        np.write()`, title: 'íŒŒì´íŒŒì´í‚¤íŠ¸ ë„¤ì˜¤í”½ì…€ ì œì–´ ì˜ˆì‹œ' },
    },
    bluetooth: {
      basic: { kind: 'code', lang: 'python', code:
`# í‹°ì²˜ë¸”ë¨¸ì‹  ë°ì´í„° ì¶œë ¥í•˜ê¸°
import ubluetooth
from simpleBle import WebBLEPeripheral

ble = ubluetooth.BLE()
ble.active(True)

p = WebBLEPeripheral(ble, "ESP32_BLE")

def on_rx(v):
  print("ìˆ˜ì‹ ", v)
  p.send(f"ë°›ì€ ë©”ì‹œì§€: {v}")

print("ì—°ê²° ëŒ€ê¸° ì¤‘...")
try:
  while True:
      time.sleep(1)
except KeyboardInterrupt:
  p.stop()
`, title: 'ê¸°ë³¸ ì˜ˆì‹œ' },
      advanced: { kind: 'code', lang: 'python', code:
`# ìŠ¤ë§ˆíŠ¸í™ˆ ëª¨í„° ì œì–´ ì˜ˆì‹œ
from servo import Servo
import ubluetooth
from simpleBle import WebBLEPeripheral

ble = ubluetooth.BLE()
ble.active(True)

p = WebBLEPeripheral(ble, "ESP32_BLE")

motor = Servo(pin=13)

def on_rx(v):
    if v == 'Class 1':
        motor.move(90)
    elif v == 'Class 2':
        motor.move(30)

print("ì—°ê²° ëŒ€ê¸° ì¤‘...")
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    p.stop()
`, title: 'ìŠ¤ë§ˆíŠ¸í™ˆPlus í‚¤íŠ¸ ëª¨í„° ì œì–´ ì˜ˆì‹œ' },
      custom: { kind: 'code', lang: 'python', code:
`# íŒŒì´íŒŒì´í‚¤íŠ¸ ë„¤ì˜¤í”½ì…€ ì œì–´ ì˜ˆì‹œ
from machine import Pin
from neopixel import NeoPixel
import ubluetooth
from simpleBle import WebBLEPeripheral

pin = Pin(14, Pin.OUT)
np = NeoPixel(pin, 12)

ble = ubluetooth.BLE()
ble.active(True)

p = WebBLEPeripheral(ble, "ESP32_BLE")

def on_rx(v):
    if v == 'Class 1':
        for i in range(0, 12):
            np[i] = (255, 255, 0)
        np.write()
    elif v == 'Class 2':
        for i in range(0, 12):
            np[i] = (0, 0, 255)
        np.write()

print("ì—°ê²° ëŒ€ê¸° ì¤‘...")
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    p.stop()
      `, title: 'íŒŒì´íŒŒì´í‚¤íŠ¸ ë„¤ì˜¤í”½ì…€ ì œì–´ ì˜ˆì‹œ' },
          },
        },

        // orange(UNO): Arduino C++ ì˜ˆì‹œ (lang=cpp)
        orange: {
          sectionTitle: { serial: 'ORANGE: ì‹œë¦¬ì–¼ ì½”ë“œ ì˜ˆì‹œ', bluetooth: 'ORANGE: ë¸”ë£¨íˆ¬ìŠ¤(BLE) ì½”ë“œ ì˜ˆì‹œ' },
          serial: {
            basic: { kind: 'code', lang: 'cpp', code:
`// í‹°ì²˜ë¸”ë¨¸ì‹  ë°ì´í„° ì¶œë ¥í•˜ê¸° (ì‹œë¦¬ì–¼ ì—ì½”)
void setup() {
  Serial.begin(9600);
}

void loop() {
  if (Serial.available()) {
    String data = Serial.readStringUntil('\\n');
    data.trim();
    Serial.println(data); // ê·¸ëŒ€ë¡œ ë˜ëŒë ¤ ë³´ë‚´ê¸°
  }
}`, title: 'ê¸°ë³¸ ì˜ˆì‹œ' },
      advanced: { kind: 'code', lang: 'cpp', code:
`// ìŠ¤ë§ˆíŠ¸í™ˆ ëª¨í„° ì œì–´ ì˜ˆì‹œ (Servo)
#include <Servo.h>
Servo myservo;

boolean blind = false;

void setup() {
  Serial.begin(9600);
}

void moveBlind(int angle) {
  myservo.attach(6);
  myservo.write(angle);
  delay(300);
  myservo.detach();
}

void loop() {
  if (Serial.available()) {
    String data = Serial.readStringUntil('\\n');
    data.trim();
    if (data == "Class 1" && blind == false) {
      moveBlind(90);
      blind = true;
    } else if (data == "Class 2" && blind == true) {
      moveBlind(30);
      blind = false;
    }
  }
}`, title: 'ìŠ¤ë§ˆíŠ¸í™ˆPlus í‚¤íŠ¸ ëª¨í„° ì œì–´ ì˜ˆì‹œ' },
    },
    bluetooth: {
      // HM-10 ê°™ì€ BLE ëª¨ë“ˆì„ ì‹œë¦¬ì–¼ë¡œ ë¶™ì—¬ ì‚¬ìš©í•˜ëŠ” ì˜ˆ (SoftwareSerial)
      basic: { kind: 'code', lang: 'cpp', code:
`// GATT web BLE í†µì‹ í•˜ê¸°
#include <SoftwareSerial.h>

SoftwareSerial BTSerial(4, 5);

void setup() {
  Serial.begin(9600);
  BTSerial.begin(9600);
  delay(1000);
  
  // ë””ë°”ì´ìŠ¤ ì´ë¦„ ì„¤ì •
  BTSerial.write("AT+NAME");
  BTSerial.write("ARDUINO_NUS"); // ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½(ì˜ë¬¸)
  BTSerial.write("\\r\\n");
  delay(300);

  BTSerial.write("AT+RESET");
  BTSerial.write("\\r\\n");
  delay(1000);
  
  // Nordic UART Service í™œì„±í™”
  BTSerial.write("AT+GATTADDSERV=UUID128=6E400001-B5A3-F393-E0A9-E50E24DCCA9E");
  BTSerial.write("\\r\\n");
  delay(300);
  
  BTSerial.write("AT+RESET");
  BTSerial.write("\\r\\n");
  delay(1000);
  
  Serial.println("BLE UART Bridge Ready");
}

void loop() {
  // ì‹œë¦¬ì–¼ì—ì„œ BLEë¡œ ë°ì´í„° ì „ì†¡
  if (BTSerial.available()) {
    String data = BTSerial.readString();
    Serial.print("Received: ");
    Serial.println(data);
    BTSerial.println(data);
  }
}`, title: 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ì˜ˆì‹œ' },
      custom: { kind: 'code', lang: 'cpp', code:
`
#include <SoftwareSerial.h>
#include <Servo.h>

SoftwareSerial BTSerial(4, 5);
Servo myservo;

boolean blind = false;

void setup() {
  Serial.begin(9600);
  BTSerial.begin(9600);
  delay(1000);
  
  // ë””ë°”ì´ìŠ¤ ì´ë¦„ ì„¤ì •
  BTSerial.write("AT+NAME");
  BTSerial.write("ARDUINO_NUS"); // ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½(ì˜ë¬¸)
  BTSerial.write("\\r\\n");
  delay(300);

  BTSerial.write("AT+RESET");
  BTSerial.write("\\r\\n");
  delay(1000);
  
  // Nordic UART Service í™œì„±í™”
  BTSerial.write("AT+GATTADDSERV=UUID128=6E400001-B5A3-F393-E0A9-E50E24DCCA9E");
  BTSerial.write("\\r\\n");
  delay(300);
  
  BTSerial.write("AT+RESET");
  BTSerial.write("\\r\\n");
  delay(1000);
  
  Serial.println("BLE UART Bridge Ready");
}

void moveBlind(int angle) {
  myservo.attach(6);
  myservo.write(angle);
  delay(300);
  myservo.detach();
}

void loop() {
  if (BTSerial.available()) {
    String data = BTSerial.readString();
    if (data == "Class 1" && blind == false) {
      moveBlind(90);
      blind = true;
    } else if (data == "Class 2" && blind == true) {
      moveBlind(30);
      blind = false;
    }
  }
}`, title: 'ìŠ¤ë§ˆíŠ¸í™ˆPlus í‚¤íŠ¸ ëª¨í„° ì œì–´ ì˜ˆì‹œ' },
          }
        }
      };

      window.currentExampleKey = null;
      
      function _getOrderedKeys(ex) {
        if (!ex) return [];
        const order = ['basic', 'advanced', 'custom'];
        return order.filter(k => !!ex[k]);
      }

      function _getDevMode() {
        const dev  = window.currentDeviceMode || (window.deviceSelect?.value) || 'microbit'; // 'microbit'|'esp32'|'orange'
        const mode = window.isBluetoothMode ? 'bluetooth' : 'serial';                         // 'serial'|'bluetooth'
        return { dev, mode };
      }

      // ì„¹ì…˜ íƒ€ì´í‹€ ê°±ì‹ 
      function updateExampleSectionTitle() {
        const el = document.getElementById('exampleSectionTitle');
        if (!el) return;
        const { dev, mode } = _getDevMode();
        const st = EXAMPLES[dev]?.sectionTitle;
        if (st && st[mode]) el.textContent = st[mode];
      }

      // ëª¨ë“œ ë¼ë²¨ ê°±ì‹ 
      function updateExampleModeLabel() {
        const labelEl = document.getElementById('exampleModeLabel');
        if (!labelEl) return;
        labelEl.textContent = window.isBluetoothMode ? '(ë¸”ë£¨íˆ¬ìŠ¤)' : '(ì‹œë¦¬ì–¼)';
      }

      // íƒ­ì„ ë‹¤ì‹œ ë§Œë“¤ê³  ì´ë²¤íŠ¸ ë°”ì¸ë”©
      function _buildExampleTabs(ex, keys, activeKey) {
        const tabsWrap = document.querySelector('.code-examples .example-tabs');
        if (!tabsWrap) return;
        tabsWrap.innerHTML = ''; // ì´ˆê¸°í™”

        keys.forEach((k, idx) => {
          const btn = document.createElement('button');
          btn.className = 'example-tab' + (k === activeKey ? ' active' : '');
          btn.dataset.example = k;
          btn.type = 'button';
          btn.textContent = ex[k]?.title || (idx === 0 ? 'ê¸°ë³¸ ì˜ˆì‹œ' : (idx === 1 ? 'ê³ ê¸‰ ì˜ˆì‹œ' : 'ì»¤ìŠ¤í…€ ì˜ˆì‹œ'));
          btn.addEventListener('click', () => {
            // íƒ­ active ì „í™˜
            tabsWrap.querySelectorAll('.example-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            window.currentExampleKey = k;
            updateExampleContent(k);
          });
          tabsWrap.appendChild(btn);
        });
      }

      // ì½˜í…ì¸  ë Œë”ëŸ¬ (ì´ë¯¸ì§€/ì½”ë“œ ëª¨ë‘ ì²˜ë¦¬)
      // ìš”êµ¬ì‚¬í•­: ì½”ë“œ ë¸”ë¡ì€ width:100% ê°€ë“, ì´ë¯¸ì§€ë§Œ ì¤‘ì•™ ì •ë ¬(+ codeUrl ìˆìœ¼ë©´ ì˜¤ë²„ë ˆì´ ë²„íŠ¼)
      function updateExampleContent(exampleKey) {
        const { dev, mode } = _getDevMode();
        const data = EXAMPLES?.[dev]?.[mode]?.[exampleKey];
        const container = document.querySelector('.code-examples .example-content');
        if (!container || !data) return;

        if (data.kind === 'image') {
          const hasBtn = !!data.codeUrl;
          container.innerHTML = `
            <div class="example-media-wrap">
              ${hasBtn ? `
                <button class="open-code-btn" type="button">ì˜ˆì‹œ ì½”ë“œ í™•ì¸í•˜ê¸°</button>
              ` : ``}
              <img src="${data.src}" alt="${data.alt || ''}" class="example-media-img" />
            </div>`;
          // ë²„íŠ¼ì— URL ì „ë‹¬
          const btn = container.querySelector('.open-code-btn');
          if (btn) btn.dataset.url = data.codeUrl;
          return;
        }

        // kind === 'code' â†’ ì „ì²´ í­ 100%, ì—¬ë°± ì—†ì´
        const lang = data.lang || 'text';
        container.innerHTML = `
          <div class="code-wrap" style="position:relative; width:100%;">
            <button class="copy-btn" type="button" aria-label="ì½”ë“œ ë³µì‚¬"
                    style="position:absolute;right:8px;top:8px;z-index:1;">
              ğŸ“‹ ë³µì‚¬í•˜ê¸°
            </button>
            <pre class="line-numbers" style="width:100%;margin:0;"><code class="language-${lang}"></code></pre>
          </div>`;
        const codeEl = container.querySelector('code');
        codeEl.textContent = data.code || '';
        if (window.Prism && Prism.highlightElement) Prism.highlightElement(codeEl);
      }

      // ê³µì§€ ë…¸ì¶œ ì—¬ë¶€(ì„ íƒ)
      function updateExampleNotice() {
        const noticeEl = document.getElementById('exampleNotice');
        if (!noticeEl) return;

        // í˜„ì¬ ì„ íƒëœ ë””ë°”ì´ìŠ¤
        const dev =
          window.currentDeviceMode ||
          (typeof deviceSelect !== 'undefined' && deviceSelect?.value) ||
          'microbit';

        const shouldShow = (dev === 'esp32') && !!window.isBluetoothMode;
        noticeEl.classList.toggle('hidden', !shouldShow);
      }

      // ì„¹ì…˜ í‘œì‹œ
      function showExamplesSection() {
        const section = document.getElementById('codeExamples') || document.querySelector('.code-examples');
        if (!section) return;
        section.classList.remove('hidden');
      }

      // í•µì‹¬: í˜„ì¬ dev/modeì— ë§ì¶° íƒ­+ì½˜í…ì¸ ë¥¼ ì¬êµ¬ì„±
      // options.resetActive === true ì¼ ë•Œ í•­ìƒ ì²« íƒ­ìœ¼ë¡œ ë¦¬ì…‹(ë””ë°”ì´ìŠ¤ ë³€ê²½ ì‹œ)
      function rebuildExamplesUI(options = {}) {
        const { dev, mode } = _getDevMode();
        const ex = EXAMPLES[dev]?.[mode];
        const tabsWrap = document.querySelector('.code-examples .example-tabs');
        const content  = document.querySelector('.code-examples .example-content');

        if (!tabsWrap || !content) return;

        if (!ex) {
          tabsWrap.innerHTML = '';
          content.innerHTML  = '';
          return;
        }

        const keys = _getOrderedKeys(ex);
        if (!keys.length) {
          tabsWrap.innerHTML = '';
          content.innerHTML  = '';
          return;
        }

        // í™œì„± íƒ­ ê²°ì •
        let activeKey = window.currentExampleKey;
        if (options.resetActive || !activeKey || !ex[activeKey]) {
          activeKey = keys[0]; // í•­ìƒ ì²« ë²ˆì§¸ë¡œ
        }
        window.currentExampleKey = activeKey;

        // ê·¸ë¦¬ê¸°
        _buildExampleTabs(ex, keys, activeKey);
        updateExampleSectionTitle();
        updateExampleModeLabel();
        updateExampleNotice();
        updateExampleContent(activeKey);
        showExamplesSection();

        // ìœ„ì„(ë³µì‚¬/ì½”ë“œì—´ê¸°) ë°”ì¸ë”© 1íšŒ
        if (!content._delegatedBound) {
          content.addEventListener('click', (e) => {
            // ë³µì‚¬
            const copyBtn = e.target.closest('.copy-btn');
            if (copyBtn) {
              const codeElement = content.querySelector('code');
              if (!codeElement) { alert('ë¨¼ì € ì½”ë“œ ì˜ˆì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
              const code = codeElement.textContent;
              navigator.clipboard.writeText(code)
                .then(() => {
                  copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬ë¨!';
                  copyBtn.classList.add('success');
                  setTimeout(() => { copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸°'; copyBtn.classList.remove('success'); }, 1600);
                })
                .catch(() => {
                  copyBtn.textContent = 'âŒ ë³µì‚¬ ì‹¤íŒ¨';
                  setTimeout(() => { copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸°'; }, 1600);
                });
              return;
            }
            // ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ë²„íŠ¼
            const openBtn = e.target.closest('.open-code-btn');
            if (openBtn) {
              const url = openBtn.dataset.url;
              if (url) window.open(url, '_blank', 'noopener,noreferrer');
              else alert('ì´ ì˜ˆì‹œì— ëŒ€í•œ ì½”ë“œ URLì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
          });
          content._delegatedBound = true;
        }
      }

      /* === ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•˜ëŠ” ê³µê°œ í•¨ìˆ˜ë“¤(í˜¸í™˜ìš©) === */

      // ì´ˆê¸°í™”(ìµœì´ˆ 1íšŒ)
      function initializeCodeExamples() {
        rebuildExamplesUI({ resetActive: true });
      }

      // ë””ë°”ì´ìŠ¤ ë³€ê²½ ì‹œ: íƒ­ì„ ì²˜ìŒìœ¼ë¡œ ë¦¬ì…‹
      function resetExampleTabsToFirst() {
        rebuildExamplesUI({ resetActive: true });
      }

      // ëª¨ë“œ(ì‹œë¦¬ì–¼/ë¸”ë£¨íˆ¬ìŠ¤) ë³€ê²½ ì‹œ: íƒ­ ìœ ì§€, ë‚´ìš©ë§Œ êµì²´
      function updateExampleContentForMode() {
        rebuildExamplesUI({ resetActive: false });
      }

      // (ë¼ë²¨ë§Œ ê°±ì‹ í•˜ê³  ì‹¶ì„ ë•Œ ì“¸ ìˆ˜ë„ ìˆì§€ë§Œ rebuildExamplesUIê°€ ëª¨ë‘ ì²˜ë¦¬í•¨)
      window.updateExampleModeLabel      = updateExampleModeLabel;
      window.updateExampleSectionTitle   = updateExampleSectionTitle;
      window.updateExampleContentForMode = updateExampleContentForMode;
      window.resetExampleTabsToFirst     = resetExampleTabsToFirst;
      window.initializeCodeExamples      = initializeCodeExamples;

      function renderInstructions(device /* 'microbit'|'esp32'|'orange' */) {
        let instructions;

        const isBLE = !!window.isBluetoothMode;

        if (device === 'microbit') {
          if (isBLE) {
            instructions = [
              'Web Bluetoothë¥¼ ì§€ì›í•˜ëŠ” ê¸°ê¸°(PC/ëª¨ë°”ì¼)ì˜ Chrome/Edge ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.<br><ul style="margin-left: 20px; margin-top: 5px;"><li>Android : <a href="https://play.google.com/store/apps/details?id=com.android.chrome&hl=ko" target="_blank">Chrome</a> ì‚¬ìš©</li><li style="margin-bottom: 5px;">iOS : <a href="https://apps.apple.com/kr/app/bluefy-web-ble-browser/id1492822055" target="_blank">Bluefy</a> ì‚¬ìš©</li></ul>',
              'í—¤ë”ì—ì„œ ë””ë°”ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.',
              'í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥ í›„ "ëª¨ë¸ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
              'ë§ˆì´í¬ë¡œë¹„íŠ¸ì— BLE ì½”ë“œë¥¼ ì‘ì„±/ì—…ë¡œë“œí•˜ì„¸ìš”.<br><ul style="margin-left: 20px; margin-top: 5px;"><li>ì—ë””í„° ìš°ì¸¡ ìƒë‹¨ì˜ ì„¤ì •ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ í”„ë¡œì íŠ¸ ì„¤ì •-><strong>"í˜ì´ë§ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ëˆ„êµ¬ë‚˜ ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ í†µí•´ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."</strong>ë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.</li></ul>',
              'ìƒë‹¨ "ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë§ˆì´í¬ë¡œë¹„íŠ¸ì™€ ë¸”ë£¨íˆ¬ìŠ¤ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.',
              'ì›¹ìº  ì¸ì‹ ê²°ê³¼ê°€ ë¸”ë£¨íˆ¬ìŠ¤ë¡œ ë§ˆì´í¬ë¡œë¹„íŠ¸ì— ì „ì†¡ë©ë‹ˆë‹¤.',
              'ì½”ë“œ ìˆ˜ì • ì‹œ ì—°ê²° í•´ì œí•œ ë‹¤ìŒ ì—ë””í„°ì—ì„œ ì½”ë“œ ì—…ë¡œë“œ í›„ ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.'
            ];
          } else {
            instructions = [
              'í—¤ë”ì—ì„œ ë””ë°”ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.',
              'í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥ í›„ "ëª¨ë¸ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
              'ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—ë””í„°ì—ì„œ ì‹œë¦¬ì–¼ í†µì‹  ì½”ë“œë¥¼ ì‘ì„±/ì—…ë¡œë“œí•˜ì„¸ìš”.',
              'ìƒë‹¨ "ì‹œë¦¬ì–¼ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë§ˆì´í¬ë¡œë¹„íŠ¸ì™€ ì‹œë¦¬ì–¼ í†µì‹ ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.',
              'ì›¹ìº  ì¸ì‹ ê²°ê³¼ê°€ ì‹œë¦¬ì–¼ë¡œ ë§ˆì´í¬ë¡œë¹„íŠ¸ì— ì „ì†¡ë©ë‹ˆë‹¤.',
              'ì½”ë“œ ìˆ˜ì • ì‹œ ì—°ê²° í•´ì œí•œ ë‹¤ìŒ ì—ë””í„°ì—ì„œ ì½”ë“œ ì—…ë¡œë“œ í›„ ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.'
            ];
          }
        } else if (device === 'esp32') {
          if (isBLE) {
            instructions = [
              'Web Bluetoothë¥¼ ì§€ì›í•˜ëŠ” ê¸°ê¸°(PC/ëª¨ë°”ì¼)ì˜ Chrome/Edge ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.<br><ul style="margin-left: 20px; margin-top: 5px;"><li>Android : <a href="https://play.google.com/store/apps/details?id=com.android.chrome&hl=ko" target="_blank">Chrome</a> ì‚¬ìš©</li><li style="margin-bottom: 5px;">iOS : <a href="https://apps.apple.com/kr/app/bluefy-web-ble-browser/id1492822055" target="_blank">Bluefy</a> ì‚¬ìš©</li></ul>',
              'í—¤ë”ì—ì„œ ë””ë°”ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”',
              'í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥ í›„ "ëª¨ë¸ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
              'Thonnyì—ì„œ ESP32ìš© BLE ì½”ë“œë¥¼ ì‘ì„±/ì—…ë¡œë“œí•˜ì„¸ìš”.',
              'ìƒë‹¨ "ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ESP32ì™€ ë¸”ë£¨íˆ¬ìŠ¤ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.',
              'ì›¹ìº  ì¸ì‹ ê²°ê³¼ê°€ ë¸”ë£¨íˆ¬ìŠ¤ë¡œ ESP32ì— ì „ì†¡ë©ë‹ˆë‹¤.',
              'ì½”ë“œ ìˆ˜ì • ì‹œ ì—°ê²° í•´ì œí•œ ë‹¤ìŒ ì—ë””í„°ì—ì„œ ì½”ë“œ ì—…ë¡œë“œ í›„ ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.'
            ];
          } else {
            instructions = [
              'í—¤ë”ì—ì„œ ë””ë°”ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”',
              'í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥ í›„ "ëª¨ë¸ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
              'Thonnyì—ì„œ ESP32ìš© ì‹œë¦¬ì–¼ í†µì‹  ì½”ë“œë¥¼ ì‘ì„±/ì—…ë¡œë“œí•˜ì„¸ìš”.<br><ul style="margin-left: 20px; margin-top: 5px;"><li>ì½”ë“œë¥¼ ì‹¤í–‰ í›„ Thonny í”„ë¡œê·¸ë¨ ìš°ì¸¡ í•˜ë‹¨ ë˜ëŠ” ìƒë‹¨ ë©”ë‰´ë°”ì˜ ì‹¤í–‰->ì¸í„°í”„ë¦¬í„° í™˜ê²½ì„¤ì •ì—ì„œ <strong>ì‹¤í–‰í™˜ê²½ì„ Local Python3ë¡œ ë³€ê²½</strong>í•´ì•¼ í•©ë‹ˆë‹¤.</li></ul>',
              'ìƒë‹¨ "ì‹œë¦¬ì–¼ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ESP32ì™€ ì‹œë¦¬ì–¼ í†µì‹ ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.',
              'ì›¹ìº  ì¸ì‹ ê²°ê³¼ê°€ ì‹œë¦¬ì–¼ë¡œ ESP32ì— ì „ì†¡ë©ë‹ˆë‹¤.',
              'ì½”ë“œ ìˆ˜ì • ì‹œ ì—°ê²° í•´ì œí•œ ë‹¤ìŒ ì—ë””í„°ì—ì„œ ì½”ë“œ ì—…ë¡œë“œ í›„ ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.'
            ];
          }
        } else { // orange
          if (isBLE) {
            instructions = [
              'Web Bluetoothë¥¼ ì§€ì›í•˜ëŠ” ê¸°ê¸°(PC/ëª¨ë°”ì¼)ì˜ Chrome/Edge ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.<br><ul style="margin-left: 20px; margin-top: 5px;"><li>Android : <a href="https://play.google.com/store/apps/details?id=com.android.chrome&hl=ko" target="_blank">Chrome</a> ì‚¬ìš©</li><li style="margin-bottom: 5px;">iOS : <a href="https://apps.apple.com/kr/app/bluefy-web-ble-browser/id1492822055" target="_blank">Bluefy</a> ì‚¬ìš©</li></ul>',
              'í—¤ë”ì—ì„œ ë””ë°”ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”',
              'í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥ í›„ "ëª¨ë¸ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
              'Arduino IDEì—ì„œ ì˜¤ë Œì§€ë³´ë“œìš© BLE ì½”ë“œë¥¼ ì‘ì„±/ì—…ë¡œë“œí•˜ì„¸ìš”.',
              'ìƒë‹¨ "ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°" ë²„íŠ¼ìœ¼ë¡œ ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°í•©ë‹ˆë‹¤.',
              'ì›¹ìº  ì¸ì‹ ê²°ê³¼ê°€ ë¸”ë£¨íˆ¬ìŠ¤ë¡œ ì˜¤ë Œì§€ë³´ë“œì— ì „ì†¡ë©ë‹ˆë‹¤.',
              'ì½”ë“œ ìˆ˜ì • ì‹œ ì—°ê²° í•´ì œí•œ ë‹¤ìŒ ì—ë””í„°ì—ì„œ ì½”ë“œ ì—…ë¡œë“œ í›„ ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.'
            ];
          } else {
            instructions = [
              'í—¤ë”ì—ì„œ ë””ë°”ì´ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”',
              'í‹°ì²˜ë¸”ë¨¸ì‹  ëª¨ë¸ URL ì…ë ¥ í›„ "ëª¨ë¸ ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.',
              'Arduino IDEì—ì„œ ì˜¤ë Œì§€ë³´ë“œìš© ì‹œë¦¬ì–¼ í†µì‹  ì½”ë“œë¥¼ ì‘ì„±/ì—…ë¡œë“œí•˜ì„¸ìš”.',
              'ìƒë‹¨ "ì‹œë¦¬ì–¼ ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì˜¤ë Œì§€ë³´ë“œì™€ ì‹œë¦¬ì–¼ í†µì‹ ìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.',
              'ì›¹ìº  ì¸ì‹ ê²°ê³¼ê°€ ì‹œë¦¬ì–¼ë¡œ ì˜¤ë Œì§€ë³´ë“œì— ì „ì†¡ë©ë‹ˆë‹¤.',
              'ì½”ë“œ ìˆ˜ì • ì‹œ ì—°ê²° í•´ì œí•œ ë‹¤ìŒ ì—ë””í„°ì—ì„œ ì½”ë“œ ì—…ë¡œë“œ í›„ ë‹¤ì‹œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.'
            ];
          }
        }

        const html = `<ol>${instructions.map(s => `<li>${s}</li>`).join('')}</ol>`;
        const cont = document.getElementById('instructionsContent');
        if (cont) cont.innerHTML = html;

        const label = document.getElementById('instructionsModeLabel');
        if (label) label.textContent = isBLE ? '(ë¸”ë£¨íˆ¬ìŠ¤)' : '(ì‹œë¦¬ì–¼)';

        // ğŸ”¸ ë” ì´ìƒ ìˆ¨ê¸°ì§€ ì•ŠìŒ: ëª¨ë“  ê¸°ê¸°ì—ì„œ ì˜ˆì‹œ ì˜ì—­ í‘œì‹œ
        const codeExamples = document.getElementById('codeExamples');
        if (codeExamples) {
          codeExamples.classList.remove('hidden');
        }
      }


      /* ---------- ì´ˆê¸° ë Œë” ---------- */
      renderInstructions(initialUiDevice);
      initializeCodeExamples();
      try {
        window.updateExampleModeLabel && window.updateExampleModeLabel();
        window.updateExampleContentForMode && window.updateExampleContentForMode();
        window.updateExampleNotice && window.updateExampleNotice();
        updateConnectionTypeLabel();
        setConnectButtonText(window.isBluetoothMode ? 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°' : 'ì‹œë¦¬ì–¼ ì—°ê²°');
      } catch (e) {}

      /* ---------- ëª¨ë¸ ë¡œë“œ ---------- */
      if (loadModelBtn) {
        loadModelBtn.addEventListener('click', function () {
          const url = (modelUrlInput?.value || '').trim();
          if (url && window.setModelUrl) window.setModelUrl(url);
          else alert('ì˜¬ë°”ë¥¸ ëª¨ë¸ URLì„ ì…ë ¥í•˜ì„¸ìš”.');
        });
      }

      /* ---------- ë„ì›€ë§ ---------- */
      if (helpButtonDesktop) helpButtonDesktop.addEventListener('click', beginTutorialFromStart);
      if (helpButtonMobile && helpButtonMobile !== helpButtonDesktop) {
        helpButtonMobile.addEventListener('click', beginTutorialFromStart);
      }

      /* ---------- ëª¨ë°”ì¼ ì •ì±… & ì „ì†¡ ë°©ì‹ í† ê¸€(ì‹œë¦¬ì–¼â†”BLE) ---------- */
      // ëª¨ë°”ì¼ ì—¬ë¶€ ì¬í‰ê°€ (DevTools ì—ë®¬ë ˆì´í„° ì „í™˜ë„ ì¦‰ì‹œ ë°˜ì˜)
      function detectMobileLike() {
        try {
          const ua = navigator.userAgent || navigator.vendor || '';
          const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet|Silk|Kindle/i.test(ua);
          const isIPadOSDesktopClass = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
          const pointerCoarse = matchMedia('(pointer: coarse)').matches; // DevTools ëª¨ë°”ì¼ ëª¨ë“œì—ì„œ true
          return isMobileUA || isIPadOSDesktopClass || pointerCoarse;
        } catch (e) {
          return window.isMobileDevice || false;
        }
      }

      // í† ê¸€ ì ê¸ˆ/í•´ì œ UI ì²˜ë¦¬
      function lockTransportToggleUI() {
        if (!connectionToggle) return;
        connectionToggle.classList.add('active', 'locked');
        connectionToggle.title = 'ëª¨ë°”ì¼ì—ì„œëŠ” ë¸”ë£¨íˆ¬ìŠ¤ë§Œ ì§€ì›ë©ë‹ˆë‹¤';
        connectionToggle.style.pointerEvents = 'none';
        connectionToggle.setAttribute('aria-disabled', 'true');
        // ì‹œê°ì  ë¹„í™œì„±í™”(íšŒìƒ‰í†¤)
        connectionToggle.style.filter = 'grayscale(100%)';
        connectionToggle.style.opacity = '0.6';
      }
      function unlockTransportToggleUI() {
        if (!connectionToggle) return;
        connectionToggle.classList.remove('locked');
        connectionToggle.removeAttribute('aria-disabled');
        connectionToggle.style.pointerEvents = '';
        connectionToggle.title = '';
        connectionToggle.style.filter = '';
        connectionToggle.style.opacity = '';
        // í˜„ì¬ ìƒíƒœ ë°˜ì˜í•´ì„œ active í† ê¸€ ìœ ì§€
        connectionToggle.classList.toggle('active', !!window.isBluetoothMode);
      }

      // BLE ê³ ì • ì ìš©(ëª¨ë°”ì¼ì¼ ë•Œ í˜¸ì¶œ)
      function enforceMobileBleMode() {
        // ìƒíƒœ ê³ ì •
        window.isBluetoothMode = true;
        window.AppState?.setTransport('ble');
        window.connectionManager?.setTransport('ble');

        // UI ì ê¸ˆ
        lockTransportToggleUI();

        // ë²„íŠ¼ ë¼ë²¨
        setConnectButtonText('ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°');

        // ì‹œë¦¬ì–¼ ë‹«ê¸°
        try { window.closeSerialPort && window.closeSerialPort(); } catch (e) {}

        // UI ë™ê¸°í™”
        const uiDevice = deviceSelect?.value || window.currentDeviceMode || 'microbit'; // 'microbit'|'esp32'|'orange'
        try {
          updateConnectionTypeLabel?.();
          updateExampleModeLabel?.();
          updateExampleSectionTitle?.();
          updateExampleContentForMode?.();
          renderInstructions?.(getCurrentUiDevice());
        } catch (e) {}
      }

      // ë°ìŠ¤í¬í†± ëª¨ë“œë¡œ ëŒì•„ì™”ì„ ë•Œ(ì ê¸ˆ í•´ì œ)
      function releaseDesktopMode() {
        // ì ê¸ˆ í•´ì œ
        unlockTransportToggleUI();

        // í˜„ì¬ ìƒíƒœ ìœ ì§€(ì‚¬ìš©ìê°€ ì‹œë¦¬ì–¼/ë¸”ë£¨íˆ¬ìŠ¤ í† ê¸€ ê°€ëŠ¥)
        setConnectButtonText(window.isBluetoothMode ? 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°' : 'ì‹œë¦¬ì–¼ ì—°ê²°');

        const uiDevice = deviceSelect?.value || window.currentDeviceMode || 'microbit';
        try {
          updateConnectionTypeLabel?.();
          updateExampleModeLabel?.();
          updateExampleSectionTitle?.();
          updateExampleContentForMode?.();
          renderInstructions?.(getCurrentUiDevice());
        } catch (e) {}
      }

      // í™˜ê²½ ë³€ê²½ ê°ì§€ â†’ ì¦‰ì‹œ ì ìš©
      let _lastMobileFlag = undefined;
      function handleMobileModeMaybeChanged() {
        const nowMobile = detectMobileLike();
        if (_lastMobileFlag === nowMobile) return; // ë³€ê²½ ì—†ìŒ
        _lastMobileFlag = nowMobile;
        window.isMobileDevice = nowMobile;

        if (nowMobile) enforceMobileBleMode();
        else           releaseDesktopMode();
      }

      // âœ… ì´ˆê¸° í•œ ë²ˆ í‰ê°€
      handleMobileModeMaybeChanged();

      // âœ… í™˜ê²½ ë³€í™”ì— ë°˜ì‘ (DevTools ì „í™˜/ë¦¬ì‚¬ì´ì¦ˆ ë“±)
      try {
        // pointer íŠ¹ì„± ë³€ê²½(DevTools ëª¨ë°”ì¼ í† ê¸€ ì‹œ ìì£¼ ë°”ë€œ)
        const mqlCoarse = matchMedia('(pointer: coarse)');
        mqlCoarse.addEventListener?.('change', handleMobileModeMaybeChanged);
        // í™”ë©´ í¬ê¸° ë³€ê²½ì—ë„ í•œë²ˆ ë” í™•ì¸
        let _rzTimer = null;
        window.addEventListener('resize', () => {
          clearTimeout(_rzTimer);
          _rzTimer = setTimeout(handleMobileModeMaybeChanged, 120);
        });
        // í¬ì»¤ìŠ¤/ê°€ì‹œì„± ë³€í™” ì‹œ ì¬í‰ê°€(DevTools í† ê¸€ í›„ í¬ì»¤ìŠ¤)
        window.addEventListener('focus', handleMobileModeMaybeChanged);
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') handleMobileModeMaybeChanged();
        });
      } catch (e) {}

      // âœ… ì „ì†¡ ë°©ì‹ í† ê¸€(ë°ìŠ¤í¬í†±ì—ì„œë§Œ ë™ì‘)
      if (connectionToggle) {
        connectionToggle.addEventListener('click', function () {
          handleMobileModeMaybeChanged(); // í´ë¦­ ì‹œì ì˜ í™˜ê²½ ì¬í‰ê°€

          if (window.isMobileDevice) {
            alert('ëª¨ë°”ì¼ì—ì„œëŠ” ë¸”ë£¨íˆ¬ìŠ¤ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
            enforceMobileBleMode(); // í˜¹ì‹œ ë°”ë€Œì—ˆìœ¼ë©´ ë‹¤ì‹œ ê³ ì •
            return;
          }

          // í† ê¸€ ìƒíƒœ ë³€ê²½
          window.isBluetoothMode = !window.isBluetoothMode;
          connectionToggle.classList.toggle('active', window.isBluetoothMode);
          setConnectButtonText(window.isBluetoothMode ? 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°' : 'ì‹œë¦¬ì–¼ ì—°ê²°');
          updateConnectionTypeLabel?.();

          // ìƒíƒœ ë°˜ì˜
          const transport = window.isBluetoothMode ? 'ble' : 'serial';
          window.AppState?.setTransport(transport);
          window.connectionManager?.setTransport(transport);

          // BLEë¡œ ì „í™˜ ì‹œ ê¸°ì¡´ ì‹œë¦¬ì–¼ ë‹«ê¸°
          if (window.isBluetoothMode && typeof window.closeSerialPort === 'function') {
            try { window.closeSerialPort(); } catch (e) {}
          }

          // UI ë™ê¸°í™” (íƒ­ì€ ìœ ì§€)
          const uiDevice = deviceSelect?.value || window.currentDeviceMode || 'microbit';
          try {
            updateExampleModeLabel?.();
            updateExampleSectionTitle?.();
            updateExampleContentForMode();
            renderInstructions?.(getCurrentUiDevice());
          } catch (e) {}
        });
      }

      /* ---------- ë””ë°”ì´ìŠ¤ ë“œë¡­ë‹¤ìš´(ì§„ì‹¤ ì†ŒìŠ¤) ---------- */
      if (deviceSelect) {
        deviceSelect.addEventListener('change', () => {
          const uiDevice = deviceSelect.value; // 'microbit'|'esp32'|'orange'
          window.currentDeviceMode = uiDevice;

          // AppState/ConnectionManager ìª½ setDevice í˜¸ì¶œì€ ê·¸ëŒ€ë¡œ ìœ ì§€
          window.AppState.setDevice(uiDevice === 'orange' ? 'uno' : uiDevice);
          window.connectionManager.setDevice(uiDevice === 'orange' ? 'uno' : uiDevice);

          // ë¼ë²¨/í…Œë§ˆ/í—¤ë”
          applyThemeForDevice(uiDevice);
          updateHeaderTitleByDevice(uiDevice);
          if (currentDeviceSpan) {
            currentDeviceSpan.textContent = UI_DEVICE_LABEL[uiDevice] || 'ë§ˆì´í¬ë¡œë¹„íŠ¸';
          }

          // ì˜ˆì‹œ/ê°€ì´ë“œ
          resetExampleTabsToFirst();
          updateExampleSectionTitle();
          updateExampleContent('basic');
          renderInstructions(uiDevice);

          // (ì„ íƒ) ê¸°ì¡´ bleManager ëª¨ë“œ ë™ê¸°í™”
          try {
            if (window.bleManager?.setMode) {
              window.bleManager.setMode(uiDevice === 'orange' ? 'orange' : uiDevice);
            }
          } catch (e) {}
        });
      }

      /* ---------- ì—°ê²° ë²„íŠ¼ ---------- */
      if (connectButton) {
        connectButton.addEventListener('click', async function () {
          try {
            if (window.connectionManager.isConnected()) {
              setConnectButtonText('ì—°ê²° í•´ì œ ì¤‘â€¦');
              await window.connectionManager.disconnect();
            } else {
              setConnectButtonText('ì—°ê²° ì¤‘â€¦');
              await window.connectionManager.connect();
            }
          } catch (e) {
            console.error(e);
            alert('ì—°ê²° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + (e && e.message ? e.message : e));
          } finally {
            // ìµœì¢… ë¼ë²¨ ì •ë¦¬
            if (window.connectionManager.isConnected()) setConnectButtonText('ì—°ê²° í•´ì œ');
            else setConnectButtonText(window.isBluetoothMode ? 'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°' : 'ì‹œë¦¬ì–¼ ì—°ê²°');
          }
        });
      }

      /* ---------- ì´ˆê¸° íŠœí† ë¦¬ì–¼ ---------- */
      try {
        if (getTutorialStatus() === 'not_started') {
          if (typeof window.startTutorial === 'function') window.startTutorial();
          else setTutorialStatus('in_progress');
        }
      } catch (e) {}

    </script>
    <script>
        // ë°˜ì‘í˜•: ì„¤ì • ë°”ë¥¼ ì˜¤ë²„ë ˆì´ë¡œ ì´ë™/ë³µê·€
        (function() {
            const settingsBar = document.querySelector('.header-settings-bar');
            const overlayMount = document.getElementById('overlaySettingsMount');
            const mobileHint = document.querySelector('.mobile-hint');
            const headerToggleBtnEl = document.getElementById('headerToggleBtn');
            const headerEl = document.querySelector('.header');
            const containerEl = document.querySelector('.serial-connection .container');
            let previousDesktopCollapsed = false;
            let placeholder = null;

            function isMobileWidth() {
                return window.matchMedia('(max-width: 900px)').matches;
            }

            function moveToOverlay() {
                if (!settingsBar || !overlayMount) return;
                // ì´ë¯¸ ì˜¤ë²„ë ˆì´ì— ìˆìœ¼ë©´ ì¬-appendí•˜ì—¬ í¬ì»¤ìŠ¤ê°€ í’€ë¦¬ì§€ ì•Šë„ë¡ ì¡°ê¸° ì¢…ë£Œ
                if (settingsBar.parentNode === overlayMount) {
                    if (mobileHint) mobileHint.style.display = 'block';
                    if (headerToggleBtnEl) headerToggleBtnEl.style.display = 'none';
                    return;
                }
                // ë°ìŠ¤í¬í†± ì ‘í˜ ìƒíƒœ ì €ì¥ í›„ ëª¨ë°”ì¼ì—ì„œëŠ” í•­ìƒ í¼ì¹¨
                previousDesktopCollapsed = settingsBar.classList.contains('closed');
                settingsBar.classList.remove('closed');
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.id = 'headerSettingsPlaceholder';
                    if (settingsBar.parentNode) {
                        settingsBar.parentNode.insertBefore(placeholder, settingsBar);
                    }
                }
                overlayMount.appendChild(settingsBar);
                if (mobileHint) mobileHint.style.display = 'block';
                if (headerToggleBtnEl) headerToggleBtnEl.style.display = 'none';
            }

            function moveToDesktop() {
                if (!settingsBar || !placeholder || !placeholder.parentNode) return;
                // ì´ë¯¸ placeholder ë°”ë¡œ ì•ì— ìˆìœ¼ë©´ ë¶ˆí•„ìš”í•œ ì¬ë°°ì¹˜ë¥¼ í•˜ì§€ ì•ŠìŒ
                if (settingsBar.previousSibling !== placeholder) {
                    placeholder.parentNode.insertBefore(settingsBar, placeholder);
                }
                placeholder.remove();
                placeholder = null;
                if (mobileHint) mobileHint.style.display = 'none';
                if (headerToggleBtnEl) headerToggleBtnEl.style.display = '';
                // ë°ìŠ¤í¬í†±ìœ¼ë¡œ ë³µê·€ ì‹œ ì´ì „ ì ‘í˜ ìƒíƒœ ë³µì› ë° íŒ¨ë”© ë°˜ì˜
                if (previousDesktopCollapsed) {
                    settingsBar.classList.add('closed');
                    if (headerToggleBtnEl) headerToggleBtnEl.classList.add('closed');
                    if (containerEl) containerEl.style.paddingTop = '180px';
                } else {
                    settingsBar.classList.remove('closed');
                    if (headerToggleBtnEl) headerToggleBtnEl.classList.remove('closed');
                    if (containerEl) containerEl.style.paddingTop = '360px';
                }
            }

            function applyLayout() {
                if (isMobileWidth()) {
                    // ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ìˆìœ¼ë©´ ì„¤ì • ë°”ëŠ” ì´ë¯¸ ì˜¤ë²„ë ˆì´ì— ìˆì–´ì•¼ í•¨
                    moveToOverlay();
                    // ëª¨ë°”ì¼ì—ì„œ ì»¨í…Œì´ë„ˆ ìƒë‹¨ ì—¬ë°±: í—¤ë” ë†’ì´ + 30px
                    if (headerEl && containerEl) {
                        const headerRect = headerEl.getBoundingClientRect();
                        const topPadding = Math.max(0, headerRect.height + 30);
                        containerEl.style.paddingTop = topPadding + 'px';
                    }
                } else {
                    moveToDesktop();
                    // ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ ìˆë‹¤ë©´ ë‹«ê¸°
                    const overlay = document.getElementById('navOverlay');
                    const btn = document.getElementById('hamburgerBtn');
                    if (overlay && overlay.classList.contains('open')) {
                        overlay.classList.remove('open');
                        if (btn) btn.classList.remove('open');
                        document.body.style.overflow = '';
                    }
                    // ë°ìŠ¤í¬í†± íŒ¨ë”©ì€ ì ‘í˜ ìƒíƒœì— ë§ì¶° ë°˜ì˜
                    if (containerEl && settingsBar) {
                        const isClosed = settingsBar.classList.contains('closed');
                        containerEl.style.paddingTop = isClosed ? '180px' : '360px';
                    }
                }
            }

            const EDITOR_BUTTON_MAP = {
              microbit: {
                label: 'ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—ë””í„° ì—´ê¸°',
                url:   'https://makecode.microbit.org/#editor',
              },
              esp32: {
                label: 'Thonny IDE ë‹¤ìš´ë¡œë“œ',
                url:   'https://thonny.org/',
              },
              orange: { // Arduino UNO
                label: 'Arduino IDE ë‹¤ìš´ë¡œë“œ',
                url:   'https://www.arduino.cc/en/software',
              }
            };

            function updateEditorButton(uiDevice) {
              const cfg = EDITOR_BUTTON_MAP[uiDevice] || EDITOR_BUTTON_MAP.microbit;
              const btn = document.getElementById('editorButton');
              if (!btn) return;
              btn.textContent = cfg.label;
              btn.dataset.url = cfg.url;           // í˜„ì¬ URLì€ data ì†ì„±ì— ì €ì¥ (ê³ ì • í•¸ë“¤ëŸ¬ê°€ ì½ìŒ)
            }

            // ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ë¥¼ ë‹¨ í•œ ë²ˆë§Œ ë°”ì¸ë”©
            (function bindEditorButtonOnce() {
              let btn = document.getElementById('editorButton');
              if (!btn) return;

              // í˜¹ì‹œ ì´ì „ì— addEventListenerë¡œ ë¶™ì€ í•¸ë“¤ëŸ¬ê°€ ìˆë‹¤ë©´ "ì´ˆê¸° 1íšŒë§Œ" ì™„ì „ ì´ˆê¸°í™”
              // (í´ë¡  êµì²´ë¡œ ëª¨ë“  ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°)
              const clone = btn.cloneNode(true);
              btn.parentNode.replaceChild(clone, btn);
              btn = clone;

              if (btn._bound) return;     // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€
              btn.addEventListener('click', () => {
                // ë§¤ í´ë¦­ ì‹œì ì˜ ìµœì‹  URL ì‚¬ìš© (data-url ê¸°ë°˜)
                const url = btn.dataset.url || EDITOR_BUTTON_MAP.microbit.url;
                window.open(url, '_blank', 'noopener,noreferrer');
              });
              btn._bound = true;
            })();

            // ì´ˆê¸° ì„¸íŒ…
            updateEditorButton(initialUiDevice);

            // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ ë¼ë²¨/URLë§Œ ê°±ì‹  (í•¸ë“¤ëŸ¬ ì¶”ê°€ ë°”ì¸ë”© ë¶ˆí•„ìš”)
            if (deviceSelect) {
              deviceSelect.addEventListener('change', () => {
                const uiDevice = deviceSelect.value; // 'microbit' | 'esp32' | 'orange'
                updateEditorButton(uiDevice);
              });
            }

            window.addEventListener('resize', applyLayout);
            // ëª¨ë°”ì¼ í‚¤ë³´ë“œ í‘œì‹œë¡œ ë°œìƒí•˜ëŠ” ì¦ì€ resizeì—ì„œ DOM ì¬ë°°ì¹˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ rAF ë””ë°”ìš´ìŠ¤
            let _resizeRaf = null;
            window.removeEventListener && window.removeEventListener('resize', applyLayout);
            window.addEventListener('resize', function() {
                if (_resizeRaf) cancelAnimationFrame(_resizeRaf);
                _resizeRaf = requestAnimationFrame(applyLayout);
            });
            window.addEventListener('orientationchange', applyLayout);
            document.addEventListener('DOMContentLoaded', applyLayout);
            // ì´ˆê¸° ì ìš© (DOMContentLoaded ì´ì „ ì‹¤í–‰ ëŒ€ë¹„)
            applyLayout();
        })();
    </script>
</body>
</html>