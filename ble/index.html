<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›¹ ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  - ì˜¤ë Œì§€ë³´ë“œ/ESP32/ë§ˆì´í¬ë¡œë¹„íŠ¸</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../static/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../static/favicon/favicon-16x16.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../common/header.css">
    <link rel="stylesheet" href="../common/template.css">
    <link rel="stylesheet" href="style.css">
</head>

<body class="ble-interface">
    <div class="header">
        <a href="../index.html" class="back-btn" title="ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°">&lt; ë©”ì¸í™”ë©´</a>
        <div class="header-content">
            <!-- ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
            <button id="headerToggleBtn" class="btn-small header-toggle-btn" title="ì„¤ì • ì ‘ê¸°/í¼ì¹˜ê¸°"></button>
            <!-- ê¸°ì¡´ í—¤ë” íƒ€ì´í‹€/ì„¤ëª… -->
            <div class="header-title-desc">
                <h1 id="headerTitle">ì›¹ ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹ </h1>
                <p>ì˜¤ë Œì§€ë³´ë“œ/ESP32/ë§ˆì´í¬ë¡œë¹„íŠ¸ì™€ì˜ ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹ ì„ ìœ„í•œ ì›¹ ì¸í„°í˜ì´ìŠ¤</p>
            </div>
            <div class="header-settings-bar">
                <!-- 1. MCU í† ê¸€ (ì™¼ìª½) -->
                <div class="header-settings-col header-settings-left">
                    <div class="settings-title">ë””ë°”ì´ìŠ¤ ì„ íƒ</div>
                    <div class="device-select-container">
                        <select id="deviceSelect" class="device-select">
                            <option value="esp32" selected>ESP32</option>
                            <option value="orange">ì˜¤ë Œì§€ë³´ë“œ</option>
                            <option value="microbit">ë§ˆì´í¬ë¡œë¹„íŠ¸</option>
                        </select>
                    </div>
                </div>
                <!-- 2. ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ë²„íŠ¼ (ê°€ìš´ë°) -->
                <div class="header-settings-col header-settings-right">
                    <div class="settings-title">ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</div>
                    <button id="connectBtn" class="btn">
                        <span class="status-indicator status-disconnected"></span>
                        <span id="connectBtnText">ì—°ê²°í•˜ê¸°</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="mode-toggle">
            <button class="mode-btn active" data-mode="chat">ì±„íŒ… ëª¨ë“œ</button>
            <button class="mode-btn" data-mode="buttonBoard">ë²„íŠ¼ ë³´ë“œ</button>
        </div>
        <div class="main-section">

            <div class="content-section">
                <!-- Mode Toggle -->
                
                <!-- Chat Mode -->
                <div id="chatMode" class="mode-content active">
                    <div class="instructions-panel">
                        <div class="instructions-accordion-header" id="instructionsHeaderChat">
                            <div class="instructions-accordion-title">ì£¼ì˜ì‚¬í•­ ë° ì‚¬ìš© ë°©ë²•</div>
                            <span class="instructions-accordion-arrow">â–¼</span>
                        </div>
                        <div class="instructions" id="instructionsChatWrapper">
                            <div id="instructionsChat"></div>
                        </div>
                    </div>
                    <div class="chat-container">
                        <div class="chat-header">
                            <h3>ë¸”ë£¨íˆ¬ìŠ¤ ë©”ì‹œì§€ ì£¼ê³ ë°›ê¸°</h3>
                            <p>ë¸”ë£¨íˆ¬ìŠ¤ ì¥ì¹˜ì— ì—°ê²°í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                        <div class="messages" id="chatMessages"></div>
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                            <button id="sendBtn">ì „ì†¡</button>
                        </div>
                    </div>
                </div>
                
                <!-- Button Board Mode -->
                <div id="buttonBoardMode" class="mode-content">
                    <div class="instructions-panel">
                        <div class="instructions-accordion-header" id="instructionsHeaderBoard">
                            <div class="instructions-accordion-title">ì£¼ì˜ì‚¬í•­ ë° ì‚¬ìš© ë°©ë²•</div>
                            <span class="instructions-accordion-arrow">â–¼</span>
                        </div>
                        <div class="instructions" id="instructionsButtonBoardWrapper">
                            <div id="instructionsButtonBoard"></div>
                        </div>
                    </div>
                    <div class="button-grid-container">
                        <div class="button-header">
                            <h3>ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„° ì „ì†¡í•˜ê¸°</h3>
                        </div>
                        <div class="preset-selector">
                            <label for="presetSelect">í”„ë¦¬ì…‹ ì„ íƒ: </label>
                            <select id="presetSelect">
                                <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                                <option value="numpad">ìˆ«ì íŒ¨ë“œ</option>
                                <option value="gamepad">ê²Œì„ íŒ¨ë“œ</option>
                            </select>
                        </div>
                        
                        <div class="grid-size-selector preset-custom-only">
                            <div>
                                <label>ê·¸ë¦¬ë“œ í¬ê¸° ì„¤ì •</label>
                                <select id="gridRows">
                                    <option value="1">1 í–‰</option>
                                    <option value="2">2 í–‰</option>
                                    <option value="3">3 í–‰</option>
                                    <option value="4">4 í–‰</option>
                                    <option value="5" selected>5 í–‰</option>
                                </select>
                                <select id="gridCols">
                                    <option value="1">1 ì—´</option>
                                    <option value="2">2 ì—´</option>
                                    <option value="3">3 ì—´</option>
                                    <option value="4">4 ì—´</option>
                                    <option value="5" selected>5 ì—´</option>
                                </select>
                            </div>
                        </div>

                        <!-- Grid Controls -->
                        <div class="grid-controls preset-custom-only">
                            <div class="grid-controls-left">
                                <button id="createGrid" class="btn">ê·¸ë¦¬ë“œ ìƒì„±</button>
                            </div>
                            <div class="grid-controls-right">
                                <button id="editGrid" class="btn">í¸ì§‘ ëª¨ë“œ</button>
                                <button id="saveGrid" class="btn" style="display: none;">ì €ì¥</button>
                                <button id="cancelEdit" class="btn" style="display: none;">ì·¨ì†Œ</button>
                            </div>
                        </div>
                        
                        <div class="button-grid" id="buttonGrid">
                            <!-- Buttons will be generated by JavaScript -->
                        </div>
                        
                        
                        <!-- Button Editor Modal -->
                        <div id="btnModalOverlay" class="modal-overlay hidden">
                            <div id="btnModal" class="modal-card">
                                <div class="modal-header">
                                    <h3>ë²„íŠ¼ ì„¤ì •</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="form-row">
                                        <label>ë¼ë²¨ (ìµœëŒ€ 6ì)</label>
                                        <input type="text" id="btnLabel" class="form-input" maxlength="6">
                                    </div>
                                    <div class="form-row">
                                        <label>ì „ì†¡í•  ê°’</label>
                                        <input type="text" id="btnValue" class="form-input">
                                    </div>
                                    <div class="form-row">
                                        <label>ì•„ì´ì½˜</label>
                                        <div class="icon-input-row">
                                            <select id="btnIcon" class="form-input">
                                                <option value="">ì—†ìŒ</option>
                                                <optgroup label="Font Awesome">
                                                    <option value="fas fa-power-off">ì „ì›</option>
                                                    <option value="fas fa-play">ì¬ìƒ</option>
                                                    <option value="fas fa-pause">ì¼ì‹œì •ì§€</option>
                                                    <option value="fas fa-stop">ì •ì§€</option>
                                                    <option value="fas fa-volume-up">ì†Œë¦¬</option>
                                                </optgroup>
                                                <optgroup label="í™”ì‚´í‘œ (Unicode)">
                                                    <option value="emoji-â†">â†</option>
                                                    <option value="emoji-â†‘">â†‘</option>
                                                    <option value="emoji-â†’">â†’</option>
                                                    <option value="emoji-â†“">â†“</option>
                                                    <option value="emoji-â†”">â†”</option>
                                                    <option value="emoji-â†•">â†•</option>
                                                    <option value="emoji-â†–">â†–</option>
                                                    <option value="emoji-â†—">â†—</option>
                                                    <option value="emoji-â†˜">â†˜</option>
                                                    <option value="emoji-â†™">â†™</option>
                                                </optgroup>
                                                <optgroup label="ì´ëª¨ì§€">
                                                    <option value="emoji-ğŸ˜€">ğŸ˜€</option>
                                                    <option value="emoji-ğŸ”¥">ğŸ”¥</option>
                                                    <option value="emoji-ğŸ‘">ğŸ‘</option>
                                                    <option value="emoji-ğŸš€">ğŸš€</option>
                                                </optgroup>
                                            </select>
                                            <div class="icon-preview" title="ì•„ì´ì½˜ ë¯¸ë¦¬ë³´ê¸°">
                                                <i id="btnIconPreview"></i>
                                                <span id="btnEmojiPreview" class="emoji-preview"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <label>ë°°ê²½ìƒ‰</label>
                                        <input type="color" id="btnBgColor" value="#ffffff">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button id="saveBtnConfig" class="btn">ì €ì¥</button>
                                    <button id="deleteBtnConfig" class="btn btn-danger">ì‚­ì œ</button>
                                    <button id="cancelBtnConfig" class="btn btn-secondary">ì·¨ì†Œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ê°„ë‹¨í•œ ì•Œë¦¼ (ì „ì—­)
        window.showNotification = function(message, type = 'success') {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            } catch (e) {
                console.log(`[${type}] ${message}`);
            }
        };

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, type = 'received') {
            const messages = document.getElementById('chatMessages');
            if (!messages) return;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString();
            messageDiv.appendChild(document.createElement('br'));
            messageDiv.appendChild(timeSpan);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // ì‚¬ìš©ë°©ë²• ë Œë”ë§
        function renderInstructions(mode) {
            try {
                const containerId = mode === 'chat' ? 'instructionsChat' : 'instructionsButtonBoard';
                const container = document.getElementById(containerId);
                if (!container) return;

                const warningHTML = `
                    <div class="warning-banner">
                        <div class="warning-title">ì£¼ì˜ì‚¬í•­</div>
                        <ul>
                            <li>ì´ í˜ì´ì§€ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ëŠ” ê¸°ê¸°(PC/ëª¨ë°”ì¼)ì˜ Chrome/Edge ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.</li>
                            <li>Androidì˜ ê²½ìš° <a href="https://play.google.com/store/apps/details?id=com.android.chrome&hl=ko" target="_blank">Chrome ë¸Œë¼ìš°ì €</a>ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</li>
                            <li>iPhone(iOS Safari)ì€ Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                ì‚¬ìš©ì„ ìœ„í•´ <a href="https://apps.apple.com/app/bluefy/id6462895808" target="_blank">Bluefy App</a>ì„ ì„¤ì¹˜í•˜ì„¸ìš”.</li>
                            <li>PCì˜ ë¸”ë£¨íˆ¬ìŠ¤ í•˜ë“œì›¨ì–´ì™€ ë“œë¼ì´ë²„ê°€ ì •ìƒ ë™ì‘í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                `;

                const steps = mode === 'chat'
                    ? [
                        'ìƒë‹¨ ë“œë¡­ë‹¤ìš´ì—ì„œ ì‚¬ìš©í•  ë””ë°”ì´ìŠ¤(ì˜¤ë Œì§€ë³´ë“œ/ESP32/ë§ˆì´í¬ë¡œë¹„íŠ¸)ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.',
                        'ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¥ì¹˜ë¥¼ ì„ íƒí•˜ê³  ì—°ê²°í•©ë‹ˆë‹¤.',
                        'ì—°ê²°ì´ ë˜ë©´, ì±„íŒ… ì…ë ¥ì°½ì— ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  â€œì „ì†¡â€ì„ í´ë¦­í•˜ê±°ë‚˜ ì—”í„°í‚¤ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.',
                        'ìƒëŒ€ ì¥ì¹˜ì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ëŒ€í™”ì°½ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.',
                        'ë””ë°”ì´ìŠ¤ ëª¨ë“œë¥¼ ë³€ê²½í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì—°ê²°ì´ ëŠê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                        'ë””ë°”ì´ìŠ¤ë¥¼ ì—°ê²° í•´ì œí•˜ë ¤ë©´ ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ì—°ê²°ì„ ëŠìŠµë‹ˆë‹¤.'
                    ]
                    : [
                        'ìƒë‹¨ ë“œë¡­ë‹¤ìš´ì—ì„œ ì‚¬ìš©í•  ë””ë°”ì´ìŠ¤(ì˜¤ë Œì§€ë³´ë“œ/ESP32/ë§ˆì´í¬ë¡œë¹„íŠ¸)ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.',
                        'í”„ë¦¬ì…‹(ìˆ«ì íŒ¨ë“œ/ê²Œì„ íŒ¨ë“œ) ë˜ëŠ” ì‚¬ìš©ì ì •ì˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.',
                        'ì‚¬ìš©ì ì •ì˜ì¼ ê²½ìš° ê·¸ë¦¬ë“œ í¬ê¸°ë¥¼ ì„ íƒí•˜ê³  â€œê·¸ë¦¬ë“œ ìƒì„±â€ì„ í´ë¦­í•©ë‹ˆë‹¤.',
                        'â€œí¸ì§‘ ëª¨ë“œâ€ì—ì„œ ê° ë²„íŠ¼ì˜ ë¼ë²¨/ì „ì†¡ê°’/ì•„ì´ì½˜/ìƒ‰ìƒì„ ì„¤ì •í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.',
                        'ë²„íŠ¼ ì¶”ê°€ë¡œ ë²„íŠ¼ì„ ì¶”ê°€í•  ìˆ˜ ìˆìœ¼ë©°, ìµœëŒ€ í–‰ì— ë„ë‹¬í•˜ë©´ ì—´ì´ ì¦ê°€í•©ë‹ˆë‹¤.',
                        'ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì„¤ì •ëœ ê°’ì´ ë¸”ë£¨íˆ¬ìŠ¤ í†µí•´ ì¥ì¹˜ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.',
                        'ë””ë°”ì´ìŠ¤ ëª¨ë“œë¥¼ ë³€ê²½í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì—°ê²°ì´ ëŠê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                        'ë””ë°”ì´ìŠ¤ë¥¼ ì—°ê²° í•´ì œí•˜ë ¤ë©´ ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²° ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ì—°ê²°ì„ ëŠìŠµë‹ˆë‹¤.'
                    ];

                const stepsHTML = `<h3>ì‚¬ìš© ë°©ë²•</h3><ol>${steps.map(s => `<li>${s}</li>`).join('')}</ol>`;
                container.innerHTML = warningHTML + stepsHTML;
            } catch (e) {
                console.warn('renderInstructions error:', e);
            }
        }

        // ì•ˆë‚´ íŒ¨ë„ ì•„ì½”ë””ì–¸ í† ê¸€ ìƒíƒœ ì €ì¥/ë³µì› (ìš°ì¸¡ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼)
        function setupInstructionsToggle() {
            const chatHeader = document.getElementById('instructionsHeaderChat');
            const chatWrapper = document.getElementById('instructionsChatWrapper');
            const boardHeader = document.getElementById('instructionsHeaderBoard');
            const boardWrapper = document.getElementById('instructionsButtonBoardWrapper');

            // ê¸°ë³¸: í¼ì³ì§„ ìƒíƒœ(true) - ë‹¨ì¼ í‚¤ë¡œ í†µí•©
            const visibleStored = localStorage.getItem('ble.instructions.visible');
            const isOpen = visibleStored === null ? true : visibleStored === 'true';

            // ì´ˆê¸° í‘œì‹œ ìƒíƒœ ë™ê¸°í™”
            if (chatHeader && chatWrapper) {
                chatWrapper.style.display = isOpen ? 'block' : 'none';
                chatHeader.classList.toggle('open', isOpen);
            }
            if (boardHeader && boardWrapper) {
                boardWrapper.style.display = isOpen ? 'block' : 'none';
                boardHeader.classList.toggle('open', isOpen);
            }

            // í•˜ë‚˜ë¥¼ í´ë¦­í•˜ë©´ ì–‘ìª½ ë™ê¸°í™” + ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°˜ì˜
            function toggleAllBy(nextOpen) {
                if (chatWrapper && chatHeader) {
                    chatWrapper.style.display = nextOpen ? 'block' : 'none';
                    chatHeader.classList.toggle('open', nextOpen);
                }
                if (boardWrapper && boardHeader) {
                    boardWrapper.style.display = nextOpen ? 'block' : 'none';
                    boardHeader.classList.toggle('open', nextOpen);
                }
                localStorage.setItem('ble.instructions.visible', String(nextOpen));
            }

            if (chatHeader) {
                chatHeader.addEventListener('click', () => {
                    const nextOpen = !(chatWrapper && chatWrapper.style.display !== 'none');
                    toggleAllBy(nextOpen);
                });
            }

            if (boardHeader) {
                boardHeader.addEventListener('click', () => {
                    const nextOpen = !(boardWrapper && boardWrapper.style.display !== 'none');
                    toggleAllBy(nextOpen);
                });
            }
        }

        // BLE ë§¤ë‹ˆì € (ESP32/ì•„ë‘ì´ë…¸ ê²¸ìš©)
        class BLEManager {
            constructor() {
                this.device = null;
                this.server = null;
                this.service = null;
                this.txCharacteristic = null; // 0x0002
                this.rxCharacteristic = null; // 0x0003
                this.serviceUUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
                this.txUUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
                this.rxUUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
                this.deviceMode = 'esp32'; // 'esp32' | 'orange' | 'microbit'
                this._onReceive = null;
            }

            setMode(mode) {
                this.deviceMode = mode;
            }

            onReceive(cb) {
                this._onReceive = cb;
            }

            isConnected() {
                return !!(this.device && this.device.gatt && this.device.gatt.connected);
            }

            async connect() {
                try {
                    this._updateStatusUI('ì—°ê²° ì¤‘...', 'connecting');

                    let options;
                    if (this.deviceMode === 'esp32') {
                        options = { filters: [ { services: [ this.serviceUUID ] } ] };
                    } else if (this.deviceMode === 'orange') {
                        options = { filters: [ { name: 'ARDUINO_NUS' }, { namePrefix: 'ARDUINO' } ], optionalServices: [ this.serviceUUID ] };
                    } else { // microbit
                        options = { filters: [ { namePrefix: 'BBC micro:bit' }, { namePrefix: 'micro:bit' } ], optionalServices: [ this.serviceUUID ] };
                    }

                    this.device = await navigator.bluetooth.requestDevice(options);
                    this.device.addEventListener('gattserverdisconnected', () => this._onDisconnected());

                    this.server = await this.device.gatt.connect();
                    this.service = await this.server.getPrimaryService(this.serviceUUID);

                    if (this.deviceMode === 'microbit') {
                        const chars = await this.service.getCharacteristics();
                        this.txCharacteristic = chars.find(c => {
                            try { return c.properties.notify || c.properties.indicate; } catch { return false; }
                        });
                        this.rxCharacteristic = chars.find(c => {
                            try { return c.properties.write || c.properties.writeWithoutResponse; } catch { return false; }
                        });
                        if (!this.txCharacteristic || !this.rxCharacteristic) {
                            throw new Error('micro:bit íŠ¹ì„±(TX/RX)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                        try { await this.txCharacteristic.startNotifications(); } catch(e1) { await new Promise(r=>setTimeout(r,120)); await this.txCharacteristic.startNotifications(); }
                        this.txCharacteristic.addEventListener('characteristicvaluechanged', (event) => this._handleNotify(event));
                    } else {
                        this.txCharacteristic = await this.service.getCharacteristic(this.txUUID);
                        this.rxCharacteristic = await this.service.getCharacteristic(this.rxUUID);
                        // ì•Œë¦¼ ì„¤ì •: ESP32ëŠ” TX(0x0002), ì•„ë‘ì´ë…¸ëŠ” RX(0x0003)
                        const isESP32 = this.deviceMode === 'esp32';
                        if (isESP32) {
                            await this.txCharacteristic.startNotifications();
                            this.txCharacteristic.addEventListener('characteristicvaluechanged', (event) => this._handleNotify(event));
                        } else {
                            await this.rxCharacteristic.startNotifications();
                            this.rxCharacteristic.addEventListener('characteristicvaluechanged', (event) => this._handleNotify(event));
                        }
                    }

                    this._updateStatusUI('ì—°ê²°ë¨', 'connected');
                    addMessage(`ì—°ê²°ë¨: ${this.device.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì¹˜'}`, 'received');
                } catch (error) {
                    console.error('ì—°ê²° ì‹¤íŒ¨:', error);
                    window.showNotification(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                    this._updateStatusUI('ì—°ê²° ì‹¤íŒ¨', 'disconnected');
                    this._reset();
                }
            }

            async disconnect() {
                try {
                    // ì•Œë¦¼ í•´ì œ
                    try {
                        if (this.deviceMode === 'microbit' && this.txCharacteristic) {
                            await this.txCharacteristic.stopNotifications();
                        }
                        if (this.deviceMode === 'esp32' && this.txCharacteristic) {
                            await this.txCharacteristic.stopNotifications();
                        }
                        if (this.deviceMode === 'orange' && this.rxCharacteristic) {
                            await this.rxCharacteristic.stopNotifications();
                        }
                    } catch (e) {}

                    if (this.device) {
                        if (this.device.gatt.connected) {
                            await this.device.gatt.disconnect();
                        }
                    }
                } catch (e) {
                    console.warn('disconnect error:', e);
                } finally {
                    this._updateStatusUI('ì—°ê²° ëŠê¹€', 'disconnected');
                    addMessage('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.', 'received');
                    this._reset();
                }
            }

            async sendMessage(text) {
                const msg = (text || '').trim();
                if (!msg) return;
                if (!this.isConnected()) {
                    window.showNotification('ì˜¤ë¥˜: BLE ì¥ì¹˜ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(msg + '\n'); // ëª¨ë“  ëª¨ë“œ ê°œí–‰ í†µì¼
                    if (this.deviceMode === 'microbit') {
                        await this._writeChunked(this.rxCharacteristic, data);
                    } else if (this.deviceMode === 'esp32') {
                        await this.rxCharacteristic.writeValue(data);
                    } else { // orange (Arduino NUS)
                        await this.txCharacteristic.writeValue(data);
                    }
                } catch (error) {
                    console.error('ì „ì†¡ ì‹¤íŒ¨:', error);
                    window.showNotification(`ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }

            async _writeChunked(characteristic, bytes) {
                const CHUNK = 20;
                for (let i = 0; i < bytes.length; i += CHUNK) {
                    const slice = bytes.slice(i, i + CHUNK);
                    try {
                        if (characteristic.properties && characteristic.properties.write) {
                            await characteristic.writeValue(slice);
                        } else {
                            await characteristic.writeValueWithoutResponse(slice);
                        }
                    } catch (e) {
                        try { await characteristic.writeValueWithoutResponse(slice); }
                        catch(e2) { await characteristic.writeValue(slice); }
                    }
                    await new Promise(r => setTimeout(r, 5));
                }
            }

            _handleNotify(event) {
                try {
                    const value = event.target.value;
                    const decoder = new TextDecoder('utf-8');
                    const text = decoder.decode(value).trim();
                    if (text) {
                        if (typeof this._onReceive === 'function') this._onReceive(text);
                    }
                } catch (e) {
                    console.warn('notify decode error:', e);
                }
            }

            _onDisconnected() {
                this._updateStatusUI('ì—°ê²° ëŠê¹€', 'disconnected');
                this._reset();
                window.showNotification('ì¥ì¹˜ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
            }

            _reset() {
                this.device = null;
                this.server = null;
                this.service = null;
                this.txCharacteristic = null;
                this.rxCharacteristic = null;
            }

            _updateStatusUI(text, status) {
                const connectBtn = document.getElementById('connectBtn');
                const connectBtnText = document.getElementById('connectBtnText');
                const statusIndicator = document.querySelector('.status-indicator');
                if (connectBtnText) connectBtnText.textContent = text;
                if (statusIndicator) {
                    statusIndicator.className = 'status-indicator ' + (
                        status === 'connected' ? 'status-connected' :
                        status === 'connecting' ? 'status-connecting' :
                        'status-disconnected'
                    );
                }
            }
        }

        // ì „ì—­ BLE ì—°ê²° ì¸ìŠ¤í„´ìŠ¤
        window.bleConnection = new BLEManager();

        // UI ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.addEventListener('DOMContentLoaded', () => {
            // ëª¨ë“œ ì „í™˜ (ì±„íŒ…/ë²„íŠ¼ë³´ë“œ)
            const chatMode = document.getElementById('chatMode');
            const buttonBoardMode = document.getElementById('buttonBoardMode');
            const modeButtons = document.querySelectorAll('.mode-btn');
            modeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    chatMode.classList.remove('active');
                    buttonBoardMode.classList.remove('active');
                    this.classList.add('active');
                    if (this.dataset.mode === 'chat') {
                        chatMode.classList.add('active');
                        renderInstructions('chat');
                    } else {
                        buttonBoardMode.classList.add('active');
                        renderInstructions('buttonBoard');
                    }
                });
            });

            // í—¤ë” ì ‘ê¸°/í¼ì¹˜ê¸°
            const headerToggleBtn = document.getElementById('headerToggleBtn');
            const headerSettings = document.querySelector('.header-settings-bar');
            const container = document.querySelector('.ble-interface .container');
            function updateContainerPadding() {
                const isClosed = headerSettings.classList.contains('closed');
                const w = window.innerWidth;
                let paddingTop;
                if (w <= 480) {
                    paddingTop = isClosed ? '50px' : '150px';
                } else {
                    paddingTop = isClosed ? '100px' : '250px';
                }
                if (container) container.style.paddingTop = paddingTop;
            }
            headerToggleBtn.addEventListener('click', function() {
                headerSettings.classList.toggle('closed');
                this.classList.toggle('closed');
                updateContainerPadding();
            });
            window.addEventListener('resize', updateContainerPadding);
            headerSettings.style.display = 'flex';
            document.querySelector('.mode-btn[data-mode="chat"]').click();
            renderInstructions('chat');
            setupInstructionsToggle();

            // ë””ë°”ì´ìŠ¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë° ì´ˆê¸° ëª¨ë“œ ì„¤ì •
            const deviceSelect = document.getElementById('deviceSelect');
            const connectBtnTextEl = document.getElementById('connectBtnText');
            function applyDeviceSelection(mode) {
                const headerTitle = document.getElementById('headerTitle');
                const body = document.body;
                body.classList.remove('theme-esp32', 'theme-orange', 'theme-microbit');
                if (mode === 'esp32') {
                    headerTitle.textContent = 'ì›¹ ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  (ESP32)';
                    body.classList.add('theme-esp32');
                    if (connectBtnTextEl) connectBtnTextEl.textContent = 'ESP32 ì—°ê²°';
                } else if (mode === 'orange') {
                    headerTitle.textContent = 'ì›¹ ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  (ì˜¤ë Œì§€ë³´ë“œ)';
                    body.classList.add('theme-orange');
                    if (connectBtnTextEl) connectBtnTextEl.textContent = 'ì˜¤ë Œì§€ë³´ë“œ ì—°ê²°';
                } else {
                    headerTitle.textContent = 'ì›¹ ë¸”ë£¨íˆ¬ìŠ¤ í†µì‹  (ë§ˆì´í¬ë¡œë¹„íŠ¸)';
                    body.classList.add('theme-microbit');
                    if (connectBtnTextEl) connectBtnTextEl.textContent = 'ë§ˆì´í¬ë¡œë¹„íŠ¸ ì—°ê²°';
                }
                window.bleConnection.setMode(mode);
            }
            if (deviceSelect) {
                deviceSelect.addEventListener('change', async (e) => {
                    const nextMode = e.target.value;
                    // ì—°ê²° ìƒíƒœë¼ë©´ ì „í™˜ ì „ì— í•´ì œ
                    if (window.bleConnection.isConnected()) {
                        await window.bleConnection.disconnect();
                    }
                    applyDeviceSelection(nextMode);
                });
                // ì´ˆê¸°ê°’ ì ìš©
                applyDeviceSelection(deviceSelect.value || 'esp32');
            }
            if (container) {
                const w = window.innerWidth;
                container.style.paddingTop = w <= 480 ? '150px' : '250px';
            }

            // ì—°ê²°/í•´ì œ ë²„íŠ¼
            document.getElementById('connectBtn').addEventListener('click', async () => {
                if (window.bleConnection.isConnected()) {
                    await window.bleConnection.disconnect();
                } else {
                    if (!navigator.bluetooth) {
                        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    await window.bleConnection.connect();
                }
            });

            // ì±„íŒ… ì…ë ¥/ì „ì†¡
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            sendBtn.addEventListener('click', async () => {
                const text = messageInput.value.trim();
                if (!text) return;
                await window.bleConnection.sendMessage(text);
                addMessage(text, 'sent');
                messageInput.value = '';
            });
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendBtn.click();
                }
            });

            // ìˆ˜ì‹  ì½œë°±
            window.bleConnection.onReceive((text) => addMessage(text, 'received'));
        });
    </script>
    <script type="module" src="./button-grid.js"></script>
</body>
</html>